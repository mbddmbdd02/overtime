<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <title>è¿…å¾—-å°è³‡æ—çš„è¡€æ±—éŒ¢</title>
    <style>
        :root {
            --primary: #1976d2;
            --primary-soft: #e3f2fd;
            --bg: #f3f4f6;
            --card-bg: #ffffff;
            --border: #e0e0e0;
            --text-main: #1f2933;
            --text-sub: #6b7280;
            --danger: #e53935;
            --accent: #ffb300;
            --warn: #fb923c;
        }
        * { box-sizing: border-box; }
        body {
            font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
            margin: 0;
            padding: 16px;
            background: radial-gradient(circle at top, #e3f2fd, #f3f4f6 45%);
            color: var(--text-main);
        }
        .page {
            max-width: 1200px;
            margin: 0 auto;
        }
        .header-row {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 6px;
            margin-bottom: 12px;
        }
        h1 {
            margin: 0;
            font-size: 36px;
            font-weight: 800;
            text-align: center;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 6px;
        }
        h1 span.tag {
            font-size: 12px;
            padding: 3px 10px;
            border-radius: 999px;
            background: var(--primary-soft);
            color: var(--primary);
            border: 1px solid #bbdefb;
        }
        h2 {
            margin: 0 0 8px;
            font-size: 18px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        h2::before {
            content: "";
            width: 4px;
            height: 18px;
            border-radius: 999px;
            background: var(--primary);
            display: inline-block;
        }
        .card {
            background: var(--card-bg);
            padding: 12px 16px 14px;
            border-radius: 12px;
            box-shadow: 0 8px 20px rgba(15, 23, 42, 0.08);
            margin-bottom: 16px;
            border: 1px solid rgba(148, 163, 184, 0.35);
        }
        .flex-row {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            align-items: center;
        }
        label {
            margin-right: 4px;
            font-size: 13px;
            color: var(--text-sub);
        }
        input[type="number"] {
            width: 100px;
            padding: 4px 6px;
            font-size: 12px;
            border-radius: 6px;
            border: 1px solid var(--border);
            background: #f9fafb;
        }
        input[type="number"]:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 1px rgba(25,118,210,0.2);
            background: #ffffff;
        }
        select {
            font-size: 12px;
            padding: 3px 6px;
            border-radius: 6px;
            border: 1px solid var(--border);
            background: #f9fafb;
        }
        select:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 1px rgba(25,118,210,0.2);
            background: #ffffff;
        }
        .btn {
            padding: 5px 12px;
            border-radius: 999px;
            border: none;
            background: var(--primary);
            color: #fff;
            cursor: pointer;
            font-size: 12px;
            display: inline-flex;
            align-items: center;
            gap: 4px;
            box-shadow: 0 4px 10px rgba(25,118,210,0.4);
        }
        .btn span.icon { font-size: 13px; }
        .btn:active {
            transform: translateY(1px);
            box-shadow: 0 2px 6px rgba(25,118,210,0.4);
        }
        .btn-icon {
            width: 40px;
            height: 40px;
            border-radius: 999px;
            border: none;
            background: #ffffff;
            box-shadow: 0 3px 8px rgba(15, 23, 42, 0.15);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 20px;
            color: #4b5563;
        }
        .btn-icon:active { transform: translateY(1px); }
        .note {
            font-size: 11px;
            color: var(--text-sub);
            margin-top: 4px;
            line-height: 1.5;
        }
        .summary-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 8px;
            font-size: 13px;
            margin-top: 8px;
        }
        .summary-item {
            background: #f9fafb;
            border-radius: 10px;
            padding: 6px 8px;
            border: 1px solid var(--border);
        }
        .summary-item strong {
            display: block;
            font-size: 12px;
            color: var(--text-sub);
            margin-bottom: 2px;
        }
        .summary-item span.value {
            font-size: 15px;
            font-weight: 600;
            color: var(--primary);
        }
        .summary-item span.value.negative { color: var(--danger); }
        .cutoff-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(135px, 1fr));
            gap: 6px;
            margin-top: 8px;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            background: var(--card-bg);
        }
        th, td {
            border: 1px solid #e5e7eb;
            padding: 4px 6px;
            font-size: 12px;
            text-align: center;
            white-space: nowrap;
        }
        th {
            background: #f1f5f9;
            position: sticky;
            top: 0;
            z-index: 2;
        }
        tbody tr:nth-child(even):not(.weekend-row):not(.national-holiday-row) {
            background: #fdfdfd;
        }
        .holiday-date {
            color: var(--danger);
            font-weight: 600;
        }
        .weekday-row { background-color: #fffef5; }
        .weekend-row { background-color: #e8f4ff; }
        .national-holiday-row { background-color: #ffebee; }
        .scroll-card {
            max-height: 480px;
            overflow: auto;
        }
        .invalid-row {
            outline: 2px solid var(--warn);
            outline-offset: -2px;
        }
        .settings-panel.hidden { display: none; }
        .settings-title {
            font-size: 13px;
            font-weight: 600;
            margin-top: 2px;
            margin-bottom: 4px;
            color: #111827;
        }

        /* æ¢—åœ–å¡ç‰‡ */
        .meme-card {
            display: flex;
            flex-wrap: wrap;
            align-items: center;
            justify-content: space-between;
            gap: 8px;
            background: linear-gradient(135deg, #1e293b, #0f172a);
            color: #f9fafb;
            border-radius: 16px;
            padding: 12px 16px;
            box-shadow: 0 10px 24px rgba(15,23,42,0.5);
            margin-bottom: 14px;
            border: 1px solid rgba(148,163,184,0.4);
        }
        .meme-text-block {
            flex: 1;
            min-width: 0;
        }
        .meme-title {
            font-size: 26px;
            font-weight: 800;
            margin-bottom: 6px;
        }
        .meme-subtitle {
            font-size: 15px;
            opacity: 0.9;
        }
        .meme-btn-area {
            display: flex;
            align-items: center;
            gap: 8px;
        }
    </style>
</head>
<body>
    <div class="page">
        <div id="memeBar" class="card meme-card">
            <div class="meme-text-block">
                <div id="memeTitle" class="meme-title">æ¢—è¼‰å…¥ä¸­...</div>
                <div id="memeSubtitle" class="meme-subtitle">ä»Šå¤©ä¹Ÿè¦åŠªåŠ›å®ˆè­·è‡ªå·±çš„è¡€æ±—éŒ¢ã€‚</div>
            </div>
            <div class="meme-btn-area">
                <select id="memeCategory">
                    <option value="all">å…¨éƒ¨</option>
                    <option value="work">ä¸Šç­ / åŠ ç­</option>
                    <option value="life">ç”Ÿæ´» / å°åŠ‡å ´</option>
                </select>
                <button id="btnChangeMeme" class="btn">
                    <span class="icon">ğŸ²</span> æ›ä¸€å¼µæ¢—
                </button>
            </div>
        </div>

        <div class="header-row">
            <h1>
                è¿…å¾—-å°è³‡æ—çš„è¡€æ±—éŒ¢
                <span class="tag">åŠ ç­ç´€éŒ„ãƒ»è–ªè³‡è©¦ç®—ãƒ»çµç®—æ—¥</span>
            </h1>
            <button id="btnSettings" class="btn-icon" title="é–‹å•Ÿ / é—œé–‰è¨­å®š">
                âš™
            </button>
        </div>

        <div id="settingsPanel" class="card settings-panel hidden">
            <h2>è¨­å®š</h2>

            <div class="settings-block">
                <div class="settings-title">è–ªè³‡çµæ§‹</div>
                <div class="flex-row">
                    <div>
                        <label>æœ¬è–ª</label>
                        <input type="number" id="baseSalary" value="45500" step="1">
                    </div>
                    <div>
                        <label>è·å‹™åŠ çµ¦</label>
                        <input type="number" id="dutyAllowance" value="0" step="1">
                    </div>
                    <div>
                        <label>äº¤é€šæ´¥è²¼</label>
                        <input type="number" id="trafficAllowance" value="0" step="1">
                    </div>
                    <div>
                        <label>ç¶­ä¿®æ´¥è²¼</label>
                        <input type="number" id="maintenanceAllowance" value="0" step="1">
                    </div>
                    <div>
                        <label>æŒè‚¡ä¿¡è¨—å…¬æï¼ˆæ”¶å…¥ï¼‰</label>
                        <input type="number" id="stockCompanyIncome" value="0" step="1">
                    </div>
                </div>
                <div class="flex-row" style="margin-top:8px;">
                    <div>
                        <label>å‹ä¿è²»</label>
                        <input type="number" id="laborInsurance" value="0" step="1">
                    </div>
                    <div>
                        <label>å¥ä¿è²»</label>
                        <input type="number" id="healthInsurance" value="0" step="1">
                    </div>
                    <div>
                        <label>æŒè‚¡ä¿¡è¨—å…¬æï¼ˆæ”¯å‡ºï¼‰</label>
                        <input type="number" id="stockCompanyDeduct" value="0" step="1">
                    </div>
                    <div>
                        <label>æŒè‚¡ä¿¡è¨—è‡ªæ</label>
                        <input type="number" id="stockSelfDeduct" value="0" step="1">
                    </div>
                    <button class="btn" onclick="recalcAll()">
                        <span class="icon">âŸ³</span> å¥—ç”¨è–ªè³‡çµæ§‹ä¸¦é‡æ–°è¨ˆç®—
                    </button>
                </div>
                <div class="summary-grid">
                    <div class="summary-item">
                        <strong>åŠ ç­åŸºç¤æ™‚è–ª</strong>
                        <span id="hourlyBaseDisplay" class="value">0</span>
                        <div class="note">= (æœ¬è–ª + è·å‹™åŠ çµ¦ + äº¤é€šæ´¥è²¼) Ã· 240ï¼ˆå››æ¨äº”å…¥ç‚ºæ•´æ•¸å…ƒï¼‰</div>
                    </div>
                    <div class="summary-item">
                        <strong>å›ºå®šæ”¶å…¥å°è¨ˆ</strong>
                        <span id="fixedIncomeDisplay" class="value">0</span>
                    </div>
                    <div class="summary-item">
                        <strong>å›ºå®šæ”¯å‡ºå°è¨ˆ</strong>
                        <span id="fixedOutgoDisplay" class="value">0</span>
                    </div>
                </div>
            </div>

            <div class="settings-block" style="margin-top:12px;">
                <div class="settings-title">çµç®—æ—¥è¨­å®š & è–ªè³‡çµç®—æœˆä»½</div>
                <div class="note">
                    çµç®—æœˆä»½ M çš„åŠ ç­çµ±è¨ˆå€é–“ =ã€Œå‰ä¸€å€‹æœˆä»½çš„çµç®—æ—¥ +1 å¤©ã€åˆ°ã€Œæœ¬æœˆä»½çš„çµç®—æ—¥ã€ã€‚<br>
                    ä¾‹ï¼š1 æœˆçµç®—è‡³ 1/22 â†’ 1/23ï½1/31 ç®—é€² 2 æœˆè–ªè³‡ï¼›2 æœˆçµç®—è‡³ 2/25 â†’ 2/26ï½2/28 ç®—é€² 3 æœˆè–ªè³‡ã€‚
                </div>
                <div class="cutoff-grid">
                    <div><label>1 æœˆçµç®—æ—¥</label><input type="number" id="cutoff1" value="22" min="1" max="31"></div>
                    <div><label>2 æœˆçµç®—æ—¥</label><input type="number" id="cutoff2" value="25" min="1" max="31"></div>
                    <div><label>3 æœˆçµç®—æ—¥</label><input type="number" id="cutoff3" value="25" min="1" max="31"></div>
                    <div><label>4 æœˆçµç®—æ—¥</label><input type="number" id="cutoff4" value="27" min="1" max="31"></div>
                    <div><label>5 æœˆçµç®—æ—¥</label><input type="number" id="cutoff5" value="27" min="1" max="31"></div>
                    <div><label>6 æœˆçµç®—æ—¥</label><input type="number" id="cutoff6" value="26" min="1" max="31"></div>
                    <div><label>7 æœˆçµç®—æ—¥</label><input type="number" id="cutoff7" value="29" min="1" max="31"></div>
                    <div><label>8 æœˆçµç®—æ—¥</label><input type="number" id="cutoff8" value="28" min="1" max="31"></div>
                    <div><label>9 æœˆçµç®—æ—¥</label><input type="number" id="cutoff9" value="25" min="1" max="31"></div>
                    <div><label>10 æœˆçµç®—æ—¥</label><input type="number" id="cutoff10" value="29" min="1" max="31"></div>
                    <div><label>11 æœˆçµç®—æ—¥</label><input type="number" id="cutoff11" value="27" min="1" max="31"></div>
                    <div><label>12 æœˆçµç®—æ—¥</label><input type="number" id="cutoff12" value="31" min="1" max="31"></div>
                </div>
                <div class="flex-row" style="margin-top:10px;">
                    <div>
                        <label for="payMonthSelect">è–ªè³‡çµç®—æœˆä»½</label>
                        <select id="payMonthSelect" onchange="updatePayPeriodSummary(); saveState();">
                            <option value="1">1 æœˆ</option>
                            <option value="2">2 æœˆ</option>
                            <option value="3">3 æœˆ</option>
                            <option value="4">4 æœˆ</option>
                            <option value="5">5 æœˆ</option>
                            <option value="6">6 æœˆ</option>
                            <option value="7">7 æœˆ</option>
                            <option value="8">8 æœˆ</option>
                            <option value="9">9 æœˆ</option>
                            <option value="10">10 æœˆ</option>
                            <option value="11">11 æœˆ</option>
                            <option value="12">12 æœˆ</option>
                        </select>
                    </div>
                    <button class="btn" onclick="updatePayPeriodSummary(); saveState();">
                        <span class="icon">ğŸ“…</span> é‡æ–°è¨ˆç®—çµç®—å€é–“
                    </button>
                    <span id="payPeriodLabel" class="note"></span>
                </div>
            </div>

            <div class="settings-block" style="margin-top:12px;">
                <div class="settings-title">ä¸»é é¡¯ç¤ºè¨­å®š</div>
                <div>
                    <label><input type="checkbox" id="chkShowMonthlyOT" checked> é¡¯ç¤ºã€Œæœ¬æœˆåŠ ç­çµ±è¨ˆã€</label>
                </div>
                <div>
                    <label><input type="checkbox" id="chkShowMonthlyMeal" checked> é¡¯ç¤ºã€Œæœ¬æœˆèª¤é¤çµ±è¨ˆã€</label>
                </div>
                <div>
                    <label><input type="checkbox" id="chkShowSalary" checked> é¡¯ç¤ºã€Œè–ªè³‡è©¦ç®—ï¼ˆçµç®—å€é–“ï¼‰ã€</label>
                </div>

                <div class="note" style="margin-top:6px;">
                    ä¸‹æ–¹å¯å€‹åˆ¥é¸æ“‡æ¯å€‹å€å¡Šå…§è¦é¡¯ç¤ºçš„æ¬„ä½ã€‚
                </div>

                <div style="margin-top:6px; font-size:12px; font-weight:600;">ä¸€ã€æœ¬æœˆåŠ ç­çµ±è¨ˆ æ¬„ä½</div>
                <div style="font-size:12px;">
                    <label><input type="checkbox" id="fieldMonthlyTotalHours" checked> ç¸½åŠ ç­æ™‚æ•¸</label>
                    <label><input type="checkbox" id="fieldMonthly133" checked> 1.34 ç¸½æ™‚æ•¸</label>
                    <label><input type="checkbox" id="fieldMonthly166" checked> 1.67 ç¸½æ™‚æ•¸</label>
                    <label><input type="checkbox" id="fieldMonthly200" checked> 2.0 ç¸½æ™‚æ•¸</label>
                    <label><input type="checkbox" id="fieldMonthly267" checked> 2.67 ç¸½æ™‚æ•¸</label>
                    <label><input type="checkbox" id="fieldMonthlyCompHours" checked> ç¸½è£œä¼‘æ™‚æ•¸</label>
                    <label><input type="checkbox" id="fieldMonthlyCompCash" checked> è£œä¼‘æŠ˜ç¾é‡‘é¡</label>
                    <label><input type="checkbox" id="fieldMonthlyOTPay" checked> ç¸½åŠ ç­è²»</label>
                </div>

                <div style="margin-top:6px; font-size:12px; font-weight:600;">äºŒã€æœ¬æœˆèª¤é¤çµ±è¨ˆ æ¬„ä½</div>
                <div style="font-size:12px;">
                    <label><input type="checkbox" id="fieldMonthlyMealCount" checked> ç¸½èª¤é¤æ•¸</label>
                    <label><input type="checkbox" id="fieldMonthlyMealFee" checked> ç¸½èª¤é¤è²»</label>
                </div>

                <div style="margin-top:6px; font-size:12px; font-weight:600;">ä¸‰ã€è–ªè³‡è©¦ç®—ï¼ˆçµç®—å€é–“ï¼‰æ¬„ä½</div>
                <div style="font-size:12px;">
                    <label><input type="checkbox" id="fieldSalaryFixIn" checked> å›ºå®šæ”¶å…¥å°è¨ˆ</label>
                    <label><input type="checkbox" id="fieldSalaryFixOut" checked> å›ºå®šæ”¯å‡ºå°è¨ˆ</label>
                    <label><input type="checkbox" id="fieldSalaryTotalHours" checked> ç¸½åŠ ç­æ™‚æ•¸</label>
                    <label><input type="checkbox" id="fieldSalary133" checked> 1.34 æ™‚æ•¸</label>
                    <label><input type="checkbox" id="fieldSalary166" checked> 1.67 æ™‚æ•¸</label>
                    <label><input type="checkbox" id="fieldSalary200" checked> 2.0 æ™‚æ•¸</label>
                    <label><input type="checkbox" id="fieldSalary267" checked> 2.67 æ™‚æ•¸</label>
                    <label><input type="checkbox" id="fieldSalaryOTPay" checked> åŠ ç­è²»</label>
                    <label><input type="checkbox" id="fieldSalaryCompCash" checked> è£œä¼‘æŠ˜ç¾</label>
                    <label><input type="checkbox" id="fieldSalaryOncallCount" checked> on call æ¬¡æ•¸</label>
                    <label><input type="checkbox" id="fieldSalaryOncallAmount" checked> on call é‡‘é¡</label>
                    <label><input type="checkbox" id="fieldSalarySickH" checked> ç—…å‡æ™‚æ•¸</label>
                    <label><input type="checkbox" id="fieldSalarySickDed" checked> ç—…å‡æ‰£æ¬¾</label>
                    <label><input type="checkbox" id="fieldSalaryPersonalH" checked> äº‹å‡æ™‚æ•¸</label>
                    <label><input type="checkbox" id="fieldSalaryPersonalDed" checked> äº‹å‡æ‰£æ¬¾</label>
                    <label><input type="checkbox" id="fieldSalaryTotalIncome" checked> ç¸½æ”¶å…¥</label>
                </div>
            </div>

            <div class="settings-block" style="margin-top:12px;">
                <div class="settings-title">è³‡æ–™å‚™ä»½ / åŒ¯å‡º (é›²ç«¯åŒæ­¥å·²é–‹å•Ÿ)</div>
                <div class="flex-row">
                    <button class="btn" onclick="exportJSON()">
                        <span class="icon">ğŸ’¾</span> åŒ¯å‡ºè¨­å®š(JSON)
                    </button>
                    <label class="btn" for="importJsonInput">
                        <span class="icon">ğŸ“¥</span> åŒ¯å…¥è¨­å®š(JSON)
                    </label>
                    <input type="file" id="importJsonInput" accept=".json,application/json" style="display:none;">
                    <button class="btn" onclick="exportCSV()">
                        <span class="icon">ğŸ“Š</span> åŒ¯å‡ºå…¨å¹´æ˜ç´°(CSV/Excel)
                    </button>
                    <button class="btn" onclick="exportPDF()">
                        <span class="icon">ğŸ–¨</span> åŒ¯å‡º PDF
                    </button>
                </div>
                <div class="note">
                    JSONï¼šåŒ¯å‡º/åŒ¯å…¥çš„è³‡æ–™å°‡æœƒèˆ‡é›²ç«¯ Gist ä¸Šçš„è³‡æ–™åŒæ­¥ã€‚<br>
                    CSVï¼šè¼¸å‡ºç›®å‰å¹´ä»½çš„å…¨å¹´æ¯æ—¥æ˜ç´°ï¼Œå¯ç”¨ Excel é–‹å•Ÿã€‚<br>
                    PDFï¼šå‘¼å«ç€è¦½å™¨åˆ—å°ï¼Œé¸ã€Œå¦å­˜ç‚º PDFã€å³å¯ã€‚
                </div>
            </div>
        </div>

        <div class="card">
            <h2>æ—¥æ›†æœˆä»½é¸æ“‡</h2>
            <div class="flex-row">
                <div>
                    <label for="yearInput">å¹´ä»½</label>
                    <input type="number" id="yearInput" value="2025" min="2000" max="2100" style="width:80px;">
                </div>
                <div>
                    <label for="monthSelect">é¡¯ç¤ºæœˆä»½</label>
                    <select id="monthSelect" onchange="buildMonthTable()">
                        <option value="1">1 æœˆ</option>
                        <option value="2">2 æœˆ</option>
                        <option value="3">3 æœˆ</option>
                        <option value="4">4 æœˆ</option>
                        <option value="5">5 æœˆ</option>
                        <option value="6">6 æœˆ</option>
                        <option value="7">7 æœˆ</option>
                        <option value="8">8 æœˆ</option>
                        <option value="9">9 æœˆ</option>
                        <option value="10">10 æœˆ</option>
                        <option value="11">11 æœˆ</option>
                        <option value="12">12 æœˆ</option>
                    </select>
                </div>
                <div class="note">
                    å¹³æ—¥æ­£å¸¸å·¥æ™‚ï¼š08:00â€“12:00ã€13:00â€“17:00ã€‚<br>
                    ä¸Šç­é è¨­ 08:00ï¼›å¹³æ—¥ä¸‹ç­å¯é¸ 00:00ï½23:30ï¼Œå¦‚ä¸‹ç­æ™‚é–“æ—©æ–¼ / ç­‰æ–¼ä¸Šç­ï¼Œå¹³æ—¥æœƒè·³æ©˜æ¡†æé†’ä¸¦ä¸è¨ˆç®—ã€‚<br>
                    åœ‹å®šå‡æ—¥ç›®å‰å…§å»º 2025 å¹´ï¼Œå¦‚åˆ‡æ›å…¶ä»–å¹´ä»½ï¼Œåœ‹å®šå‡æ—¥ä¸æœƒè‡ªå‹•æ¨™ç´…ã€‚
                </div>
            </div>
        </div>

        <div class="card">
            <h2>on call è¨ˆç®—</h2>
            <div class="flex-row">
                <div>
                    <label>æœ¬çµç®—æœˆä»½ on call æ¬¡æ•¸</label>
                    <input type="number" id="onCallCount" value="0" step="1" min="0">
                </div>
                <div class="note">
                    on call è¨ˆç®—æ–¹å¼ï¼š1500 å…ƒ / æ¬¡ã€‚<br>
                    æ­¤æ¬¡æ•¸æœƒç´å…¥ã€Œè–ªè³‡è©¦ç®—ï¼ˆçµç®—å€é–“ï¼‰ã€çš„ç¸½æ”¶å…¥ï¼ˆä¸ç®—åœ¨é¤è²»å…§ï¼‰ã€‚<br>
                    è‹¥åˆ‡æ›ä¸åŒçµç®—æœˆä»½ï¼Œè«‹æ‰‹å‹•èª¿æ•´ç‚ºè©²æœˆä»½çš„å¯¦éš› on call æ¬¡æ•¸ã€‚
                </div>
            </div>
        </div>

        <div class="card scroll-card">
            <h2>æ¯æ—¥åŠ ç­ & å‡åˆ¥ç´€éŒ„ï¼ˆç›®å‰é¡¯ç¤ºæœˆä»½ï¼‰</h2>
            <table>
                <thead>
                    <tr>
                        <th>æ—¥æœŸ</th>
                        <th>æ˜ŸæœŸ</th>
                        <th>é¡å‹</th>
                        <th>å‡åˆ¥</th>
                        <th>ä¸Šç­</th>
                        <th>ä¸‹ç­</th>
                        <th>1.34 å°æ™‚</th>
                        <th>1.67 å°æ™‚</th>
                        <th>2.0 å°æ™‚</th>
                        <th>2.67 å°æ™‚</th>
                        <th>è£œä¼‘æ™‚æ•¸</th>
                        <th>åŠ ç­è²»</th>
                        <th>èª¤é¤æ•¸</th>
                        <th>èª¤é¤è²»</th>
                    </tr>
                </thead>
                <tbody id="daysBody"></tbody>
            </table>
            <div class="note">
                å¹³æ—¥ï¼š17:30â€“19:30 â†’ 1.34 å€ï¼›19:30â€“21:30 â†’ 1.67 å€ï¼›21:30 ä¹‹å¾Œæ”¹ç®—è£œä¼‘ï¼ˆÃ—2ï¼‰ï¼Œä¸å†ç®—åŠ ç­è²»ã€‚<br>
                å‡æ—¥ / åœ‹å®šå‡æ—¥ï¼š08:00â€“12:00ï¼‹13:00â€“17:00 â†’ 2 å€ï¼›17:30â€“21:30 â†’ 2.67 å€ï¼›12:00â€“13:00 ä¸åˆ—å…¥åŠ ç­ã€‚<br>
                å‡æ—¥ / åœ‹å®šå‡æ—¥é¤è²»ï¼šåªè¦æœ‰åŠ ç­ï¼ŒåŸºæœ¬ä¸€é¤ï¼›è‹¥åŠ ç­åˆ° 18:30 ä¹‹å¾Œï¼Œå‰‡å…©é¤ã€‚<br>
                å‡åˆ¥ï¼ˆç‰¹ä¼‘ / è£œä¿® / ç—…å‡ / äº‹å‡ï¼‰åªå½±éŸ¿å¹³æ—¥ 08â€“12ã€13â€“17 çš„çµ¦è–ªï¼Œä¸å½±éŸ¿åŠ ç­è²»ã€‚<br>
                å‘¨æœ«åŠåœ‹å®šå‡æ—¥è‹¥ä¸Šç­æ™‚é–“ â‰¥ ä¸‹ç­æ™‚é–“ï¼Œåªæ˜¯ä¸åˆ—å…¥è¨ˆç®—ï¼Œä¸æœƒé¡¯ç¤ºæ©˜æ¡†æé†’ã€‚
            </div>
        </div>

        <div id="sectionMonthlyOT" class="card">
            <h2>ä¸€ã€æœ¬æœˆåŠ ç­çµ±è¨ˆï¼ˆé¡¯ç¤ºæœˆä»½ï¼‰</h2>
            <div class="summary-grid">
                <div class="summary-item" id="itemMonthlyTotalHours">
                    <strong>ç¸½åŠ ç­æ™‚æ•¸</strong>
                    <span id="totalHours" class="value">0</span>
                </div>
                <div class="summary-item" id="itemMonthly133">
                    <strong>1.34 ç¸½æ™‚æ•¸</strong>
                    <span id="sum133" class="value">0</span>
                </div>
                <div class="summary-item" id="itemMonthly166">
                    <strong>1.67 ç¸½æ™‚æ•¸</strong>
                    <span id="sum166" class="value">0</span>
                </div>
                <div class="summary-item" id="itemMonthly200">
                    <strong>2.0 ç¸½æ™‚æ•¸</strong>
                    <span id="sum200" class="value">0</span>
                </div>
                <div class="summary-item" id="itemMonthly267">
                    <strong>2.67 ç¸½æ™‚æ•¸</strong>
                    <span id="sum267" class="value">0</span>
                </div>
                <div class="summary-item" id="itemMonthlyCompHours">
                    <strong>ç¸½è£œä¼‘æ™‚æ•¸</strong>
                    <span id="sumComp" class="value">0</span>
                </div>
                <div class="summary-item" id="itemMonthlyCompCash">
                    <strong>è£œä¼‘æŠ˜ç¾é‡‘é¡ï¼ˆæœ¬æœˆï¼‰</strong>
                    <span id="compCashMonthly" class="value">0</span>
                </div>
                <div class="summary-item" id="itemMonthlyOTPay">
                    <strong>ç¸½åŠ ç­è²»ï¼ˆæœ¬æœˆï¼‰</strong>
                    <span id="sumOTPayMonthly" class="value">0</span>
                </div>
            </div>
        </div>

        <div id="sectionMonthlyMeal" class="card">
            <h2>äºŒã€æœ¬æœˆèª¤é¤çµ±è¨ˆï¼ˆé¡¯ç¤ºæœˆä»½ï¼‰</h2>
            <div class="summary-grid">
                <div class="summary-item" id="itemMonthlyMealCount">
                    <strong>ç¸½èª¤é¤æ•¸</strong>
                    <span id="sumMealsMonthly" class="value">0</span>
                </div>
                <div class="summary-item" id="itemMonthlyMealFee">
                    <strong>ç¸½èª¤é¤è²»</strong>
                    <span id="sumMealFeeMonthly" class="value">0</span>
                </div>
            </div>
        </div>

        <div id="sectionSalary" class="card">
            <h2>ä¸‰ã€è–ªè³‡è©¦ç®—ï¼ˆçµç®—å€é–“ï¼‰</h2>
            <div class="note" id="payPeriodLabel2"></div>
            <div class="summary-grid">
                <div class="summary-item" id="itemSalaryFixIn">
                    <strong>å›ºå®šæ”¶å…¥å°è¨ˆ</strong>
                    <span id="fixedIncomeMonthly" class="value">0</span>
                </div>
                <div class="summary-item" id="itemSalaryFixOut">
                    <strong>å›ºå®šæ”¯å‡ºå°è¨ˆ</strong>
                    <span id="fixedOutgoMonthly" class="value">0</span>
                </div>
                <div class="summary-item" id="itemSalaryTotalHours">
                    <strong>çµç®—å€é–“ç¸½åŠ ç­æ™‚æ•¸</strong>
                    <span id="ppTotalHours" class="value">0</span>
                </div>
                <div class="summary-item" id="itemSalary133">
                    <strong>çµç®—å€é–“ 1.34 æ™‚æ•¸</strong>
                    <span id="ppH133" class="value">0</span>
                </div>
                <div class="summary-item" id="itemSalary166">
                    <strong>çµç®—å€é–“ 1.67 æ™‚æ•¸</strong>
                    <span id="ppH166" class="value">0</span>
                </div>
                <div class="summary-item" id="itemSalary200">
                    <strong>çµç®—å€é–“ 2.0 æ™‚æ•¸</strong>
                    <span id="ppH200" class="value">0</span>
                </div>
                <div class="summary-item" id="itemSalary267">
                    <strong>çµç®—å€é–“ 2.67 æ™‚æ•¸</strong>
                    <span id="ppH267" class="value">0</span>
                </div>
                <div class="summary-item" id="itemSalaryOTPay">
                    <strong>çµç®—å€é–“åŠ ç­è²»</strong>
                    <span id="ppSumOTPay" class="value">0</span>
                </div>
                <div class="summary-item" id="itemSalaryCompCash">
                    <strong>çµç®—å€é–“è£œä¼‘æŠ˜ç¾</strong>
                    <span id="ppCompCash" class="value">0</span>
                </div>
                <div class="summary-item" id="itemSalaryOncallCount">
                    <strong>on call æ¬¡æ•¸ï¼ˆçµç®—å€é–“ï¼‰</strong>
                    <span id="onCallCountDisplay" class="value">0</span>
                </div>
                <div class="summary-item" id="itemSalaryOncallAmount">
                    <strong>on call é‡‘é¡</strong>
                    <span id="onCallAmountDisplay" class="value">0</span>
                </div>
                <div class="summary-item" id="itemSalarySickH">
                    <strong>ç—…å‡æ™‚æ•¸ï¼ˆçµç®—å€é–“ï¼‰</strong>
                    <span id="sickHours" class="value">0</span>
                </div>
                <div class="summary-item" id="itemSalarySickDed">
                    <strong>ç—…å‡æ‰£æ¬¾ï¼ˆçµç®—å€é–“ï¼‰</strong>
                    <span id="sickDeduction" class="value negative">0</span>
                </div>
                <div class="summary-item" id="itemSalaryPersonalH">
                    <strong>äº‹å‡æ™‚æ•¸ï¼ˆçµç®—å€é–“ï¼‰</strong>
                    <span id="personalHours" class="value">0</span>
                </div>
                <div class="summary-item" id="itemSalaryPersonalDed">
                    <strong>äº‹å‡æ‰£æ¬¾ï¼ˆçµç®—å€é–“ï¼‰</strong>
                    <span id="personalDeduction" class="value negative">0</span>
                </div>
                <div class="summary-item" id="itemSalaryTotalIncome">
                    <strong>ç¸½æ”¶å…¥ï¼ˆå«è£œä¼‘æŠ˜ç¾ï¼‹on callï¼Œä¸å«é¤è²»ï¼‰</strong>
                    <span id="totalIncome" class="value">0</span>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ===============================================
        // ====== GIST é›²ç«¯åŒæ­¥è¨­å®š (å·²æ›¿æ›æ‚¨çš„å€¼) ======
        // ===============================================
        const GIST_ID = "3cc2bcacedfb21435f74ce15ef37b951";
        const PAT = "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";
        const GIST_FILENAME = "overtime_data.json";
        // ===============================================
        // ğŸš¨ è­¦å‘Š: PAT å·²å…¬é–‹å¯«åœ¨ç¨‹å¼ç¢¼ä¸­ï¼Œè«‹ç¢ºä¿æ¬Šé™ç¯„åœæœ€å°åŒ– (åƒ…å‹¾é¸ Gist)
        // ===============================================

        let currentYear = 2025;
        let dayData = {}; // YYYY-MM-DD -> { start, end, leaveType, otDetails }
        let appSettings = {}; // å„²å­˜éæ—¥æ›†ç›¸é—œè¨­å®š (è–ªè³‡ã€çµç®—æ—¥ã€é¡¯ç¤ºè¨­å®š)

        const taiwanHolidays2025 = new Set([
            "2025-01-01",
            "2025-01-27", "2025-01-28", "2025-01-29", "2025-01-30", "2025-01-31",
            "2025-02-28",
            "2025-04-03", "2025-04-04",
            "2025-05-30", "2025-05-31",
            "2025-09-29",
            "2025-10-06", "2025-10-10",
            "2025-10-24", "2025-10-25",
            "2025-12-25"
        ]);

        const memeList = [
            // work
            { title: "æ—©ä¸Šè·Ÿè‡ªå·±èªªï¼šä»Šå¤©ä¸€å®šæº–æ™‚ä¸‹ç­ã€‚", subtitle: "æ™šä¸Š 21:30 çš„ä½ ï¼šå…ˆæŠŠåŠ ç­æ™‚æ•¸ key å®Œå†èªªã€‚", tag: "work" },
            { title: "ä¸»ç®¡èªªï¼šé€™æ¡ˆå­ä¸æœƒåŠ ç­å•¦ï½", subtitle: "çµæœä½ åœ¨çµç®—æ—¥çœ‹è‘— 1.34ã€1.67 æ¬„ä½é»˜é»˜æµæ·šã€‚", tag: "work" },
            { title: "æœ‰äººå•ï¼šä½ ç‚ºä»€éº¼é‚£éº¼æœƒç®—åŠ ç­è²»ï¼Ÿ", subtitle: "æˆ‘ï¼šå› ç‚ºä¸æœƒç®—å°±æœƒè¢«å…¬å¸ç®—ã€‚", tag: "work" },
            { title: "æ‰€è¬‚æœˆå…‰æ—ï¼š", subtitle: "ä¸æ˜¯ä¸æœƒå­˜éŒ¢ï¼Œæ˜¯åŠ ç­è²»é‚„æ²’è£œé½Šæœ¬è–ªçš„æ´ã€‚", tag: "work" },
            { title: "æœ€å®³æ€•è½åˆ°çš„ä¸€å¥è©±ï¼š", subtitle: "ã€Œé€™å€‹å°±å…ˆåšï¼Œä¹‹å¾Œå†è£œ OTã€‚ã€", tag: "work" },
            { title: "çœ‹åˆ° 21:30 ä¹‹å¾Œéƒ½æ˜¯è£œä¼‘ï¼š", subtitle: "å¿ƒæƒ…è¤‡é›œï¼šæƒ³ä¼‘å‡åˆæƒ³è¦ç¾é‡‘ã€‚", tag: "work" },
            { title: "åŠ ç­åˆ°æ‡·ç–‘äººç”Ÿï¼š", subtitle: "ä½†æ‰“é–‹è©¦ç®—è¡¨çœ‹è¦‹ OT é‡‘é¡ï¼Œåˆè¦ºå¾—é‚„å¯ä»¥å†æ’ä¸€ä¸‹ã€‚", tag: "work" },
            { title: "åŒäº‹å•ï¼šç‚ºä»€éº¼ä½  Excel é‚£éº¼å¼·ï¼Ÿ", subtitle: "æˆ‘ï¼šå› ç‚ºæˆ‘è¦ç¢ºå®šæ¯ä¸€åˆ†é˜éƒ½æœ‰ç®—éŒ¢ã€‚", tag: "work" },
            { title: "åˆ¥äººèªªã€Œä¸‹ç­åƒé£¯å—ï¼Ÿã€", subtitle: "æˆ‘å…ˆçœ‹ä»Šå¤©æœ‰æ²’æœ‰è¶…é 18:30ï¼Œèª¤é¤è²»è¦ç®—é€²å»ã€‚", tag: "work" },
            { title: "æœ€æ€•è½åˆ°ï¼š", subtitle: "ã€Œé€™å€‹ç¦®æ‹œå…­å¯èƒ½è¦ä¾†ä¸€ä¸‹å–”ã€‚ã€", tag: "work" },
            { title: "åˆ¥äººé€±æœ«è¿½åŠ‡ï¼š", subtitle: "æˆ‘é€±æœ«è¿½å·¥å–®ï¼Œé †ä¾¿è¿½æˆ‘çš„åŠ ç­è²»ã€‚", tag: "work" },
            { title: "äººç”Ÿä¸‰å¤§å¹»è¦ºä¹‹ä¸€ï¼š", subtitle: "é€™æ¬¡æ‡‰è©²ä¸ç”¨åŠ ç­äº†ã€‚", tag: "work" },
            { title: "æœ‰äººèªªï¼šéŒ¢ä¸æ˜¯è¬èƒ½ã€‚", subtitle: "æˆ‘èªªï¼šä½†ç®—å®Œ OT çš„é‚£ä¸€åˆ»ï¼ŒçœŸçš„å¾ˆæœ‰å®‰å…¨æ„Ÿã€‚", tag: "work" },
            { title: "æœ€æµªæ¼«çš„å ´åˆï¼š", subtitle: "ä¸æ˜¯æµ·é‚Šçœ‹æ—¥å‡ºï¼Œæ˜¯ä¸€èµ·åœ¨è¾¦å…¬å®¤çœ‹çµç®—æ—¥ã€‚", tag: "work" },
            { title: "å¤§å®¶éƒ½èªªè¦ work-life balanceã€‚", subtitle: "æˆ‘ç›®å‰æ˜¯ work-OT balanceï¼Œå…ˆæŠŠ OT balance èµ·ä¾†ã€‚", tag: "work" },

            // life
            { title: "æ¸›è‚¥è¨ˆç•« Day 1ï¼š", subtitle: "æ™šé¤åªåƒä¸€é»é»â€¦ç„¶å¾Œå†åŠ ä¸€ä»½å®µå¤œã€‚", tag: "life" },
            { title: "é¬§é˜è¨­å…­å€‹æ™‚é–“ï¼š", subtitle: "èµ·åºŠåªç›¸ä¿¡æœ€å¾Œé‚£ä¸€å€‹ã€‚", tag: "life" },
            { title: "æ˜æ˜å¾ˆç´¯äº†é‚„ä¸ç¡ï¼š", subtitle: "å› ç‚ºè¦ºå¾—ä¸€ç¡è‘—ï¼Œä»Šå¤©å°±æ­£å¼çµæŸäº†ã€‚", tag: "life" },
            { title: "æ‰‹æ©Ÿé›»é‡ 1% æœƒç·Šå¼µï¼Œ", subtitle: "å­˜æ¬¾ 1% è¦ºå¾—é‚„å¥½ï¼Œåæ­£ç™¼è–ªæ—¥ç¸½æœƒä¾†ã€‚", tag: "life" },
            { title: "èªªè¦æ—©èµ·é‹å‹•çš„æ™šä¸Šï¼š", subtitle: "æœ€å®¹æ˜“å…ˆå¤–é€ä¸€å †é«˜ç†±é‡çŠ’è³è‡ªå·±ã€‚", tag: "life" },
            { title: "æœ€å¸¸æŒ‰çš„ä¸‰å€‹éµï¼š", subtitle: "æˆªåœ–ã€éœéŸ³ã€å»¶å¾Œé¬§é˜ã€‚", tag: "life" },
            { title: "å‡æ—¥è¡Œç¨‹è¦åŠƒï¼š", subtitle: "æ—©ä¸Šï¼šã€Œç­‰ä¸€ä¸‹å°±å‡ºé–€ã€â†’ æ™šä¸Šï¼šã€Œç®—äº†ï¼Œä¸‹æ¬¡å†èªªã€ã€‚", tag: "life" },
            { title: "é–‹å§‹å­˜éŒ¢ä¹‹å¾Œæ‰ç™¼ç¾ï¼š", subtitle: "ä¸æ˜¯æˆ‘ä¸æœƒç†è²¡ï¼Œæ˜¯ç”Ÿæ´»çœŸçš„å¾ˆæœƒèŠ±éŒ¢ã€‚", tag: "life" },
            { title: "æ‰“é–‹éŠ€è¡Œ App çš„ç¬é–“ï¼š", subtitle: "åƒåœ¨æ‹†é©šå–œåŒ…ï¼Œåªæ˜¯å¤§éƒ¨åˆ†æ˜¯é©šåš‡åŒ…ã€‚", tag: "life" },
            { title: "æ‰€è¬‚é•·å¤§ï¼š", subtitle: "çœ‹åˆ°æ‰“æŠ˜ä¸æ˜¯å¾ˆé–‹å¿ƒï¼Œæ˜¯åœ¨æƒ³ï¼šé€™å€‹æˆ‘çœŸçš„éœ€è¦å—ï¼Ÿ", tag: "life" },
            { title: "æ‰“æƒæˆ¿é–“æœ€å¯æ€•çš„ä¸€åˆ»ï¼š", subtitle: "ä¸æ˜¯é«’äº‚ï¼Œæ˜¯æ‰¾åˆ°ä¸€å¹´å‰è—èµ·ä¾†çš„ç§æˆ¿éŒ¢ã€‚", tag: "life" },
            { title: "ä»Šå¤©ä¸€å®šè¦æ—©é»ç¡ï¼", subtitle: "2 å°æ™‚å¾Œï¼šæŠ–éŸ³çœŸæ˜¯å€‹å¥½æ±è¥¿ã€‚", tag: "life" },
        ];


        // ===============================================
        // ========== è¼”åŠ©åŠŸèƒ½å‡½å¼ (æ ¼å¼åŒ–ã€æ—¥æœŸ) ==========
        // ===============================================

        // æ ¼å¼åŒ–ç‚ºå…©ä½å°æ•¸çš„æ™‚é–“
        function fmtNumber(num) {
            return (Math.round(num * 100) / 100).toFixed(2);
        }

        // æ ¼å¼åŒ–ç‚ºæ•´æ•¸é‡‘é¡ (åƒåˆ†ä½)
        function fmtMoney(num) {
            return Math.round(num).toLocaleString('en-US');
        }
        
        // åˆ¤æ–·æ˜¯å¦ç‚ºåœ‹å®šå‡æ—¥ (é™ 2025 å¹´)
        function isNationalHoliday(dateObj) {
            const y = dateObj.getFullYear();
            const m = String(dateObj.getMonth() + 1).padStart(2, '0');
            const d = String(dateObj.getDate()).padStart(2, '0');
            return taiwanHolidays2025.has(`${y}-${m}-${d}`);
        }

        // ç”¢ç”Ÿæ™‚é–“é¸æ“‡å™¨é¸é …
        const allTimes = ["", "00:00"];
        for (let h = 0; h < 24; h++) {
            for (let m = 0; m < 60; m += 30) {
                const time = `${String(h).padStart(2, '0')}:${String(m).padStart(2, '0')}`;
                if (time !== "00:00") {
                    allTimes.push(time);
                }
            }
        }
        allTimes.push("23:30");

        function createSelect(options, className) {
            const select = document.createElement("select");
            select.className = className;
            options.forEach(opt => {
                const option = document.createElement("option");
                option.value = opt;
                option.textContent = opt || "æœªå¡«";
                select.appendChild(option);
            });
            return select;
        }

        function createLeaveSelect() {
            const options = [
                { value: "normal", text: "æ­£å¸¸å‡ºå‹¤" },
                { value: "annual", text: "ç‰¹ä¼‘(å…¨æ—¥)" },
                { value: "comp", text: "è£œä¼‘(å…¨æ—¥)" },
                { value: "sick", text: "ç—…å‡(åŠè–ª)" },
                { value: "personal", text: "äº‹å‡(ç„¡è–ª)" }
            ];
            const select = document.createElement("select");
            select.className = "leave-select";
            options.forEach(opt => {
                const option = document.createElement("option");
                option.value = opt.value;
                option.textContent = opt.text;
                select.appendChild(option);
            });
            return select;
        }


        // ===============================================
        // ========== æ ¸å¿ƒè¨ˆç®—å‡½å¼ (å·²ä¿®æ­£) ==========
        // ===============================================
        
        // Function to calculate overtime hours and details for a single day
        function calculateOvertime(dateKey, startTime, endTime, isWeekend, isHoliday) {
            let ot = { h134: 0, h167: 0, h200: 0, h267: 0, hComp: 0, otPay: 0, mealCount: 0, mealFee: 0, invalid: false };
            
            // ç¢ºä¿å–å¾—åŠ ç­åŸºç¤æ™‚è–ª (æ­¤è™•æ˜¯ç´…å­—/NaN çš„ä¸»è¦ä¿®æ­£é»)
            const base = parseFloat(document.getElementById("baseSalary").value) || 0;
            const duty = parseFloat(document.getElementById("dutyAllowance").value) || 0;
            const traffic = parseFloat(document.getElementById("trafficAllowance").value) || 0;
            const hourlyBase = Math.round((base + duty + traffic) / 240); 
            
            const data = dayData[dateKey];
            if (!startTime || !endTime) {
                return ot;
            }

            const [startH, startM] = startTime.split(':').map(Number);
            const [endH, endM] = endTime.split(':').map(Number);
            
            let startMinutes = startH * 60 + startM;
            let endMinutes = endH * 60 + endM;

            // è™•ç†è·¨æ—¥å•é¡Œ (å‡è¨­æœ€é•·ä¸æœƒè¶…é 24 å°æ™‚)
            if (endMinutes < startMinutes) {
                endMinutes += 24 * 60;
            }
            
            const totalDurationMinutes = endMinutes - startMinutes;
            if (totalDurationMinutes <= 0) {
                // å¹³æ—¥ (éè«‹å‡) æ‰æœ‰æ©˜æ¡†æé†’
                ot.invalid = (!isWeekend && !isHoliday && data && data.leaveType === 'normal');
                return ot;
            }

            let otStartMinutes = 0; // ç”¨æ–¼è¨ˆç®—ç¸½åŠ ç­æ™‚é–“
            
            if (!isWeekend && !isHoliday) { 
                // å¹³æ—¥
                
                // æª¢æŸ¥æ˜¯å¦ç‚ºç„¡æ•ˆå‡ºå‹¤ (ä¸‹ç­æ™‚é–“ <= ä¸Šç­æ™‚é–“)
                if (endMinutes <= startMinutes) {
                    ot.invalid = (data && data.leaveType === 'normal');
                    return ot;
                }

                // åŠ ç­å¾ 17:30 å¾Œé–‹å§‹è¨ˆç®—
                const workEndBreak = 17 * 60 + 30; // 17:30
                
                let otPeriodMinutes = 0;

                if (endMinutes > workEndBreak) {
                    let currentStart = workEndBreak;
                    let workingMinutes = 0;
                    
                    // 1. 17:30 - 19:30 (1.34å€)
                    let periodEnd = Math.min(endMinutes, 19 * 60 + 30); // 19:30
                    if (periodEnd > currentStart) {
                        workingMinutes = periodEnd - currentStart;
                        ot.h134 = workingMinutes / 60;
                        currentStart = periodEnd;
                        otPeriodMinutes += workingMinutes;
                    }
                    
                    // 2. 19:30 - 21:30 (1.67å€)
                    periodEnd = Math.min(endMinutes, 21 * 60 + 30); // 21:30
                    if (periodEnd > currentStart) {
                        workingMinutes = periodEnd - currentStart;
                        ot.h167 = workingMinutes / 60;
                        currentStart = periodEnd;
                        otPeriodMinutes += workingMinutes;
                    }

                    // 3. 21:30 ä¹‹å¾Œ (è£œä¼‘ï¼Œ2å€)
                    if (endMinutes > currentStart) {
                        workingMinutes = endMinutes - currentStart;
                        ot.hComp = workingMinutes / 60;
                        otPeriodMinutes += workingMinutes;
                    }
                }
                
                // å¹³æ—¥èª¤é¤è²» (17:00 å¾Œä¸‹ç­ï¼Œä¸”å·¥ä½œè¶…é 17:30)
                if (endMinutes > 17 * 60) {
                    ot.mealCount = 1;
                    // å¹³æ—¥ç¬¬äºŒé¤ï¼šåŠ ç­æ™‚æ•¸é” 4 å°æ™‚ (21:30 ä¹‹å¾Œ)
                    if (endMinutes >= 21 * 60 + 30) {
                        ot.mealCount = 2;
                    }
                }
                
            } else { 
                // å‡æ—¥æˆ–åœ‹å®šå‡æ—¥ (å…¨å¤© 2.0 å€èµ·)
                
                const breakStart = 12 * 60;
                const breakEnd = 13 * 60;
                
                // è¨ˆç®— 2.0 å€æ™‚æ®µ (08:00 - 12:00, 13:00 - 17:00)
                let totalH200Minutes = 0;
                
                // 1. 08:00 - 12:00
                let h200Start = Math.max(startMinutes, 8 * 60);
                let h200End = Math.min(endMinutes, breakStart);
                if (h200End > h200Start) {
                    totalH200Minutes += (h200End - h200Start);
                }
                
                // 2. 13:00 - 17:00
                h200Start = Math.max(startMinutes, breakEnd);
                h200End = Math.min(endMinutes, 17 * 60);
                if (h200End > h200Start) {
                    totalH200Minutes += (h200End - h200Start);
                }
                
                ot.h200 = totalH200Minutes / 60;
                let currentStart = Math.max(startMinutes, 17 * 60 + 30); // å¾ 17:30 é–‹å§‹ç®— 2.67

                // è¨ˆç®— 2.67 å€æ™‚æ®µ (17:30 - 21:30)
                let h267End = Math.min(endMinutes, 21 * 60 + 30);
                if (h267End > currentStart) {
                    ot.h267 = (h267End - currentStart) / 60;
                    currentStart = h267End;
                }

                // è¨ˆç®— 21:30 ä¹‹å¾Œ (è£œä¼‘ï¼Œ2å€)
                if (endMinutes > currentStart) {
                    ot.hComp = (endMinutes - currentStart) / 60;
                }
                
                // å‡æ—¥èª¤é¤è²»
                // åªè¦æœ‰åŠ ç­ï¼ŒåŸºæœ¬ä¸€é¤ (ç•¶æ—¥å·¥æ™‚ > 0)
                if (totalDurationMinutes > 0) {
                    ot.mealCount = 1;
                    // åŠ ç­åˆ° 18:30 ä¹‹å¾Œï¼Œå…©é¤
                    if (endMinutes >= 18 * 60 + 30) {
                        ot.mealCount = 2;
                    }
                }
            }
            
            ot.otPay = ot.h134 * hourlyBase * 1.34 + 
                       ot.h167 * hourlyBase * 1.67 + 
                       ot.h200 * hourlyBase * 2.0 + 
                       ot.h267 * hourlyBase * 2.67;
            
            ot.mealFee = ot.mealCount * 80;
            
            // å°‡æ™‚æ•¸å››æ¨äº”å…¥åˆ°å°æ•¸é»å¾Œå…©ä½ (ç‚ºäº†é¡¯ç¤ºå’Œç´¯ç©)
            ot.h134 = parseFloat(fmtNumber(ot.h134));
            ot.h167 = parseFloat(fmtNumber(ot.h167));
            ot.h200 = parseFloat(fmtNumber(ot.h200));
            ot.h267 = parseFloat(fmtNumber(ot.h267));
            ot.hComp = parseFloat(fmtNumber(ot.hComp));

            return ot;
        }


        // Updates the OT fields in a specific table row (used on select change)
        function updateRowData(tr, ot) {
            const base = parseFloat(document.getElementById("baseSalary").value) || 0;
            const duty = parseFloat(document.getElementById("dutyAllowance").value) || 0;
            const traffic = parseFloat(document.getElementById("trafficAllowance").value) || 0;
            const hourlyBase = Math.round((base + duty + traffic) / 240); 
                                   
            const otPay = ot.h134 * hourlyBase * 1.34 + ot.h167 * hourlyBase * 1.67 + ot.h200 * hourlyBase * 2.0 + ot.h267 * hourlyBase * 2.67;
            const mealFee = ot.mealCount * 80;

            tr.querySelector('[data-field="h134"]').textContent = fmtNumber(ot.h134);
            tr.querySelector('[data-field="h167"]').textContent = fmtNumber(ot.h167);
            tr.querySelector('[data-field="h200"]').textContent = fmtNumber(ot.h200);
            tr.querySelector('[data-field="h267"]').textContent = fmtNumber(ot.h267);
            tr.querySelector('[data-field="hComp"]').textContent = fmtNumber(ot.hComp);
            tr.querySelector('[data-field="otPay"]').textContent = fmtMoney(otPay);
            tr.querySelector('[data-field="mealCount"]').textContent = ot.mealCount;
            tr.querySelector('[data-field="mealFee"]').textContent = fmtMoney(mealFee);
            
            // Update the row background for invalid entries
            const dateKey = tr.getAttribute('data-date-key');
            const data = dayData[dateKey];
            
            let rowClass = "weekday-row"; // default
            const dateObj = new Date(dateKey);
            const weekday = dateObj.getDay(); 
            const isWeekend = (weekday === 0 || weekday === 6);
            const isHoliday = isNationalHoliday(dateObj);

            if (isHoliday) {
                rowClass = "national-holiday-row";
            } else if (isWeekend) {
                rowClass = "weekend-row";
            }
            
            // ç§»é™¤æ‰€æœ‰ç‰¹å®šçš„è¡Œé¡åˆ¥
            tr.className = tr.className.replace(/\b(weekday-row|weekend-row|national-holiday-row|invalid-row)\b/g, '').trim();

            // é‡æ–°è¨­å®šåŸºç¤è¡Œé¡åˆ¥
            tr.classList.add(rowClass);
            
            // é‡æ–°è¨­å®šæ©˜æ¡†
            if (ot.invalid && !isWeekend && !isHoliday && data.leaveType === 'normal') {
                tr.classList.add("invalid-row");
            }
        }


        // Recalculates all summary fields based on current dayData
        function recalcAll() {
            // 1. æ›´æ–°è¨­å®šé¢æ¿çš„å›ºå®šæ”¶æ”¯
            updateFixedIncomeOutgo();

            // 2. è¨ˆç®—æœ¬æœˆçµ±è¨ˆ (ç›®å‰é¡¯ç¤ºçš„æœˆä»½)
            let sum134 = 0, sum167 = 0, sum200 = 0, sum267 = 0, sumComp = 0;
            let sumMeals = 0;
            let currentMonth = document.getElementById("monthSelect").value.padStart(2, '0');
            
            for (const dateKey in dayData) {
                if (dateKey.startsWith(`${currentYear}-${currentMonth}`)) {
                    const data = dayData[dateKey];
                    // é‡æ–°è¨ˆç®— otDetailsï¼Œå› ç‚ºè–ªè³‡åŸºæ•¸å¯èƒ½æ”¹è®Šäº†
                    const dateObj = new Date(dateKey);
                    const isWeekend = (dateObj.getDay() === 0 || dateObj.getDay() === 6);
                    const isHoliday = isNationalHoliday(dateObj);
                    data.otDetails = calculateOvertime(dateKey, data.start, data.end, isWeekend, isHoliday);
                    
                    sum134 += data.otDetails.h134;
                    sum167 += data.otDetails.h167;
                    sum200 += data.otDetails.h200;
                    sum267 += data.otDetails.h267;
                    sumComp += data.otDetails.hComp;
                    sumMeals += data.otDetails.mealCount;
                }
            }

            const base = parseFloat(document.getElementById("baseSalary").value) || 0;
            const duty = parseFloat(document.getElementById("dutyAllowance").value) || 0;
            const traffic = parseFloat(document.getElementById("trafficAllowance").value) || 0;
            const hourlyBase = Math.round((base + duty + traffic) / 240); 
            
            const totalHours = sum134 + sum167 + sum200 + sum267 + sumComp;
            const sumOTPayMonthly = (sum134 * hourlyBase * 1.34) + (sum167 * hourlyBase * 1.67) + (sum200 * hourlyBase * 2.0) + (sum267 * hourlyBase * 2.67);
            const compCashMonthly = sumComp * hourlyBase * 2.0;
            const sumMealFeeMonthly = sumMeals * 80;

            document.getElementById("totalHours").textContent = fmtNumber(totalHours);
            document.getElementById("sum133").textContent = fmtNumber(sum134);
            document.getElementById("sum166").textContent = fmtNumber(sum167);
            document.getElementById("sum200").textContent = fmtNumber(sum200);
            document.getElementById("sum267").textContent = fmtNumber(sum267);
            document.getElementById("sumComp").textContent = fmtNumber(sumComp);
            document.getElementById("sumOTPayMonthly").textContent = fmtMoney(sumOTPayMonthly);
            document.getElementById("compCashMonthly").textContent = fmtMoney(compCashMonthly);
            document.getElementById("sumMealsMonthly").textContent = sumMeals;
            document.getElementById("sumMealFeeMonthly").textContent = fmtMoney(sumMealFeeMonthly);

            // 3. è¨ˆç®—è–ªè³‡çµç®—å€é–“çµ±è¨ˆ
            updatePayPeriodSummary();

            // 4. æ›´æ–°é¡¯ç¤ºè¨­å®š
            updateVisibility();

            // 5. å„²å­˜ç‹€æ…‹
            saveState();
        }

        // é‡æ–°è¨ˆç®—å›ºå®šæ”¶æ”¯
        function updateFixedIncomeOutgo() {
            const base = parseFloat(document.getElementById("baseSalary").value) || 0;
            const duty = parseFloat(document.getElementById("dutyAllowance").value) || 0;
            const traffic = parseFloat(document.getElementById("trafficAllowance").value) || 0;
            const main = parseFloat(document.getElementById("maintenanceAllowance").value) || 0;
            const stockIn = parseFloat(document.getElementById("stockCompanyIncome").value) || 0;

            const labor = parseFloat(document.getElementById("laborInsurance").value) || 0;
            const health = parseFloat(document.getElementById("healthInsurance").value) || 0;
            const stockDeduct = parseFloat(document.getElementById("stockCompanyDeduct").value) || 0;
            const stockSelf = parseFloat(document.getElementById("stockSelfDeduct").value) || 0;
            
            const hourlyBase = Math.round((base + duty + traffic) / 240);
            
            const fixedIncome = base + duty + traffic + main + stockIn;
            const fixedOutgo = labor + health + stockDeduct + stockSelf;

            document.getElementById("hourlyBaseDisplay").textContent = fmtMoney(hourlyBase);
            document.getElementById("fixedIncomeDisplay").textContent = fmtMoney(fixedIncome);
            document.getElementById("fixedOutgoDisplay").textContent = fmtMoney(fixedOutgo);

            // æ›´æ–°è–ªè³‡è©¦ç®—å€å¡Šçš„å›ºå®šæ”¶æ”¯
            document.getElementById("fixedIncomeMonthly").textContent = fmtMoney(fixedIncome);
            document.getElementById("fixedOutgoMonthly").textContent = fmtMoney(fixedOutgo);
        }

        // ç²å–çµç®—æ—¥æœŸ
        function getCutoffDay(month) {
            return parseInt(document.getElementById(`cutoff${month}`).value, 10);
        }

        // è¨ˆç®—è–ªè³‡çµç®—å€é–“çš„ç¸½çµ
        function updatePayPeriodSummary() {
            const payMonth = parseInt(document.getElementById("payMonthSelect").value, 10);
            const year = parseInt(document.getElementById("yearInput").value, 10);

            // è–ªè³‡çµç®—å€é–“: (å‰æœˆçµç®—æ—¥ + 1) åˆ° (æœ¬æœˆçµç®—æ—¥)
            const cutoffDay = getCutoffDay(payMonth);
            
            // è™•ç†å‰ä¸€å€‹æœˆ
            let prevMonth = payMonth - 1;
            let prevYear = year;
            if (prevMonth === 0) {
                prevMonth = 12;
                prevYear = year - 1;
            }
            const prevCutoffDay = getCutoffDay(prevMonth);
            
            // çµç®—é–‹å§‹æ—¥æœŸ (å‰æœˆçµç®—æ—¥ + 1)
            let startDate = new Date(prevYear, prevMonth - 1, prevCutoffDay + 1);
            
            // çµç®—çµæŸæ—¥æœŸ (æœ¬æœˆçµç®—æ—¥)
            let endDate = new Date(year, payMonth - 1, cutoffDay);
            
            // ä¿®æ­£æ—¥æœŸé¡¯ç¤º
            const startKey = `${startDate.getFullYear()}-${String(startDate.getMonth() + 1).padStart(2, '0')}-${String(startDate.getDate()).padStart(2, '0')}`;
            const endKey = `${endDate.getFullYear()}-${String(endDate.getMonth() + 1).padStart(2, '0')}-${String(endDate.getDate()).padStart(2, '0')}`;
            
            const labelText = `çµç®—å€é–“: ${startKey} åˆ° ${endKey} (å…± ${Math.ceil((endDate - startDate) / (1000 * 60 * 60 * 24)) + 1} å¤©)`;
            document.getElementById("payPeriodLabel").textContent = labelText;
            document.getElementById("payPeriodLabel2").textContent = labelText;

            // åˆå§‹åŒ–çµ±è¨ˆ
            let ppSum134 = 0, ppSum167 = 0, ppSum200 = 0, ppSum267 = 0, ppSumComp = 0;
            let ppSickHours = 0, ppPersonalHours = 0;
            let daysInPeriod = 0;

            // è¿­ä»£è¨ˆç®—
            let currentDate = new Date(startDate);
            while (currentDate <= endDate) {
                const dateKey = `${currentDate.getFullYear()}-${String(currentDate.getMonth() + 1).padStart(2, '0')}-${String(currentDate.getDate()).padStart(2, '0')}`;
                const data = dayData[dateKey];
                
                if (data && data.otDetails) {
                    ppSum134 += data.otDetails.h134;
                    ppSum167 += data.otDetails.h167;
                    ppSum200 += data.otDetails.h200;
                    ppSum267 += data.otDetails.h267;
                    ppSumComp += data.otDetails.hComp;

                    // å‡åˆ¥æ™‚æ•¸çµ±è¨ˆ (åƒ…é‡å°å¹³æ—¥)
                    const weekday = currentDate.getDay();
                    const isWeekendOrHoliday = (weekday === 0 || weekday === 6 || isNationalHoliday(currentDate));

                    if (!isWeekendOrHoliday) {
                        daysInPeriod++; // åƒ…è¨ˆç®—å·¥ä½œæ—¥

                        if (data.leaveType === 'sick') {
                            ppSickHours += 8; // å‡è¨­å…¨æ—¥ç—…å‡ 8 å°æ™‚
                        } else if (data.leaveType === 'personal') {
                            ppPersonalHours += 8; // å‡è¨­å…¨æ—¥äº‹å‡ 8 å°æ™‚
                        }
                    }
                }
                currentDate.setDate(currentDate.getDate() + 1);
            }
            
            const base = parseFloat(document.getElementById("baseSalary").value) || 0;
            const duty = parseFloat(document.getElementById("dutyAllowance").value) || 0;
            const traffic = parseFloat(document.getElementById("trafficAllowance").value) || 0;
            const hourlyBase = Math.round((base + duty + traffic) / 240); 
            
            const ppTotalHours = ppSum134 + ppSum167 + ppSum200 + ppSum267 + ppSumComp;
            const ppSumOTPay = (ppSum134 * hourlyBase * 1.34) + (ppSum167 * hourlyBase * 1.67) + (ppSum200 * hourlyBase * 2.0) + (ppSum267 * hourlyBase * 2.67);
            const ppCompCash = ppSumComp * hourlyBase * 2.0;
            
            const sickDeduction = ppSickHours * hourlyBase * 0.5; // ç—…å‡åŠè–ª
            const personalDeduction = ppPersonalHours * hourlyBase * 1.0; // äº‹å‡ç„¡è–ª
            
            const fixedIncome = parseFloat(document.getElementById("fixedIncomeDisplay").textContent.replace(/,/g, '')) || 0;
            const fixedOutgo = parseFloat(document.getElementById("fixedOutgoDisplay").textContent.replace(/,/g, '')) || 0;
            
            const onCallCount = parseInt(document.getElementById("onCallCount").value, 10) || 0;
            const onCallAmount = onCallCount * 1500;

            const totalIncome = fixedIncome + ppSumOTPay + ppCompCash + onCallAmount - sickDeduction - personalDeduction;

            document.getElementById("ppTotalHours").textContent = fmtNumber(ppTotalHours);
            document.getElementById("ppH133").textContent = fmtNumber(ppSum134);
            document.getElementById("ppH166").textContent = fmtNumber(ppSum167);
            document.getElementById("ppH200").textContent = fmtNumber(ppSum200);
            document.getElementById("ppH267").textContent = fmtNumber(ppSum267);
            document.getElementById("ppSumOTPay").textContent = fmtMoney(ppSumOTPay);
            document.getElementById("ppCompCash").textContent = fmtMoney(ppCompCash);

            document.getElementById("onCallCountDisplay").textContent = onCallCount;
            document.getElementById("onCallAmountDisplay").textContent = fmtMoney(onCallAmount);

            document.getElementById("sickHours").textContent = ppSickHours;
            document.getElementById("sickDeduction").textContent = fmtMoney(sickDeduction);
            document.getElementById("personalHours").textContent = ppPersonalHours;
            document.getElementById("personalDeduction").textContent = fmtMoney(personalDeduction);

            document.getElementById("totalIncome").textContent = fmtMoney(totalIncome);

            // ç¢ºä¿è¨­å®šé¢æ¿ä¸­çš„ on call æ¬¡æ•¸èˆ‡ pay month ç›¸é—œè¯ (ä½†ç‚ºäº†ç°¡å–®ï¼Œç›®å‰å…ˆä¿æŒæ‰‹å‹•èª¿æ•´)
        }


        // ===============================================
        // ========== è¡¨æ ¼å»ºæ§‹å‡½å¼ (å·²ä¿®æ­£) ==========
        // ===============================================

        // Builds the month table
        function buildMonthTable() {
            currentYear = parseInt(document.getElementById("yearInput").value, 10);
            const currentMonth = parseInt(document.getElementById("monthSelect").value, 10);
            const daysBody = document.getElementById("daysBody");
            daysBody.innerHTML = "";
            
            const daysInMonth = new Date(currentYear, currentMonth, 0).getDate();

            for (let day = 1; day <= daysInMonth; day++) {
                const dateKey = `${currentYear}-${String(currentMonth).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                
                // æª¢æŸ¥ä¸¦åˆå§‹åŒ–æ—¥æœŸè³‡æ–™ (ä¿®æ­£é»: ç¢ºä¿å³ä½¿ Gist ç„¡ç´€éŒ„ä¹Ÿæœ‰é è¨­å€¼)
                if (!dayData[dateKey]) { 
                    dayData[dateKey] = { 
                        start: "08:00", 
                        end: "", 
                        leaveType: "normal", 
                        otDetails: null 
                    };
                } else if (!dayData[dateKey].start) {
                    // å¦‚æœå­˜åœ¨ä½†ç¼ºå°‘æ¬„ä½ï¼Œä¹Ÿæä¾›é è¨­å€¼
                    dayData[dateKey].start = "08:00";
                    dayData[dateKey].end = dayData[dateKey].end || "";
                    dayData[dateKey].leaveType = dayData[dateKey].leaveType || "normal";
                    dayData[dateKey].otDetails = null;
                }
            }

            for (let day = 1; day <= daysInMonth; day++) {
                const dateObj = new Date(currentYear, currentMonth - 1, day);
                const dateKey = `${currentYear}-${String(currentMonth).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                const weekday = dateObj.getDay(); // 0=Sunday, 6=Saturday
                const weekdayName = ["æ—¥", "ä¸€", "äºŒ", "ä¸‰", "å››", "äº”", "å…­"][weekday];
                
                const isWeekend = (weekday === 0 || weekday === 6);
                const isHoliday = isNationalHoliday(dateObj);
                
                const data = dayData[dateKey];
                
                // é‡æ–°è¨ˆç®— OT for display (ä½¿ç”¨ä¿®æ­£å¾Œçš„ calculateOvertime)
                const ot = calculateOvertime(dateKey, data.start, data.end, isWeekend, isHoliday);
                data.otDetails = ot; 
                
                // Determine row class and date display
                let rowClass = "weekday-row";
                let dateDisplay = day;
                let dayTypeDisplay = "å¹³æ—¥";
                
                if (isHoliday) {
                    rowClass = "national-holiday-row";
                    dateDisplay = `<span class="holiday-date">${day}</span>`;
                    dayTypeDisplay = "åœ‹å®šå‡æ—¥";
                } else if (isWeekend) {
                    rowClass = "weekend-row";
                    dateDisplay = `<span class="holiday-date">${day}</span>`;
                    dayTypeDisplay = (weekday === 0) ? "é€±æ—¥" : "é€±å…­";
                }
                
                const tr = document.createElement("tr");
                // åˆ¤æ–·æ©˜æ¡†æé†’
                if (ot.invalid) {
                    tr.className = rowClass + " invalid-row";
                } else {
                    tr.className = rowClass;
                }

                tr.setAttribute('data-date-key', dateKey);

                // Date, Weekday, Type
                tr.innerHTML = `
                    <td>${dateDisplay}</td>
                    <td>${weekdayName}</td>
                    <td>${dayTypeDisplay}</td>
                `;

                // Leave Type Select
                const tdLeave = document.createElement("td");
                const leaveSelect = createLeaveSelect();
                leaveSelect.value = data.leaveType;
                leaveSelect.setAttribute("data-type", "leaveType");
                leaveSelect.onchange = (e) => {
                    data.leaveType = e.target.value;
                    // å‡åˆ¥æ”¹è®Šæ™‚éœ€è¦é‡æ–°ç¹ªè£½è¡¨æ ¼ï¼Œå› ç‚ºå®ƒæœƒæ”¹è®Šæ©˜æ¡†é‚è¼¯
                    recalcAll(); 
                    buildMonthTable(); 
                };
                tdLeave.appendChild(leaveSelect);
                tr.appendChild(tdLeave);

                // Start Time Select
                const tdStart = document.createElement("td");
                const startSelect = createSelect(allTimes, "time-select start-time");
                startSelect.value = data.start;
                startSelect.setAttribute("data-type", "start");
                startSelect.onchange = (e) => {
                    data.start = e.target.value;
                    data.otDetails = calculateOvertime(dateKey, data.start, data.end, isWeekend, isHoliday);
                    updateRowData(tr, data.otDetails); 
                    recalcAll();
                };
                tdStart.appendChild(startSelect);
                tr.appendChild(tdStart);

                // End Time Select
                const tdEnd = document.createElement("td");
                const endSelect = createSelect(allTimes, "time-select end-time");
                endSelect.value = data.end;
                endSelect.setAttribute("data-type", "end");
                endSelect.onchange = (e) => {
                    data.end = e.target.value;
                    data.otDetails = calculateOvertime(dateKey, data.start, data.end, isWeekend, isHoliday);
                    updateRowData(tr, data.otDetails); 
                    recalcAll();
                    // ä¸‹ç­æ™‚é–“æ”¹è®Šï¼Œå¯èƒ½æœƒå½±éŸ¿å¹³æ—¥çš„æ©˜æ¡†ï¼Œæ‰€ä»¥éœ€è¦é‡æ–°å»ºæ§‹è¡¨æ ¼
                    if (!isWeekend && !isHoliday) {
                         buildMonthTable(); 
                    }
                };
                tdEnd.appendChild(endSelect);
                tr.appendChild(tdEnd);

                // Add the rest of the calculated fields
                const base = parseFloat(document.getElementById("baseSalary").value) || 0;
                const duty = parseFloat(document.getElementById("dutyAllowance").value) || 0;
                const traffic = parseFloat(document.getElementById("trafficAllowance").value) || 0;
                const hourlyBase = Math.round((base + duty + traffic) / 240); 

                const otPay = ot.h134 * hourlyBase * 1.34 + ot.h167 * hourlyBase * 1.67 + ot.h200 * hourlyBase * 2.0 + ot.h267 * hourlyBase * 2.67;
                const mealFee = ot.mealCount * 80;

                tr.innerHTML += `
                    <td data-field="h134">${fmtNumber(ot.h134)}</td>
                    <td data-field="h167">${fmtNumber(ot.h167)}</td>
                    <td data-field="h200">${fmtNumber(ot.h200)}</td>
                    <td data-field="h267">${fmtNumber(ot.h267)}</td>
                    <td data-field="hComp">${fmtNumber(ot.hComp)}</td>
                    <td data-field="otPay">${fmtMoney(otPay)}</td>
                    <td data-field="mealCount">${ot.mealCount}</td>
                    <td data-field="mealFee">${fmtMoney(mealFee)}</td>
                `;

                daysBody.appendChild(tr);
                dayData[dateKey] = data; // Final update to data object
            }
            recalcAll(); // Final recalculation after table is built
        }

        // ===============================================
        // =================== ç‹€æ…‹è™•ç† ==================
        // ===============================================
        
        // å¾ Gist è¼‰å…¥æ‰€æœ‰è³‡æ–™
        async function loadState() {
            try {
                const response = await fetch(`https://api.github.com/gists/${GIST_ID}`, {
                    headers: { 'Authorization': `token ${PAT}` }
                });

                if (!response.ok) {
                    throw new Error(`GitHub API error: ${response.statusText}`);
                }

                const gist = await response.json();
                const file = gist.files[GIST_FILENAME];

                if (file && file.content) {
                    const loadedData = JSON.parse(file.content);
                    if (loadedData.dayData) {
                        dayData = loadedData.dayData;
                    }
                    if (loadedData.appSettings) {
                        appSettings = loadedData.appSettings;
                        applySettings();
                    }
                    console.log("è³‡æ–™å¾ Gist æˆåŠŸè¼‰å…¥ã€‚");
                } else {
                    console.log("Gist æª”æ¡ˆä¸å­˜åœ¨æˆ–ç‚ºç©ºï¼Œä½¿ç”¨é è¨­å€¼ã€‚");
                    initDefaultSettings();
                }
            } catch (error) {
                console.error("è¼‰å…¥ Gist è³‡æ–™å¤±æ•—ï¼Œä½¿ç”¨é è¨­å€¼:", error);
                initDefaultSettings();
            }
            
            // åˆå§‹åŒ–æœˆä»½é¡¯ç¤º
            const today = new Date();
            document.getElementById("yearInput").value = today.getFullYear();
            document.getElementById("monthSelect").value = today.getMonth() + 1;
            buildMonthTable();
        }

        // å„²å­˜æ‰€æœ‰è³‡æ–™åˆ° Gist
        async function saveState() {
            // 1. æ”¶é›† appSettings
            collectSettings();
            
            const dataToSave = {
                dayData: dayData,
                appSettings: appSettings,
                timestamp: new Date().toISOString()
            };

            const payload = {
                description: "è¿…å¾—åŠ ç­èˆ‡è–ªè³‡è©¦ç®—æ•¸æ“š (è‡ªå‹•åŒæ­¥)",
                files: {
                    [GIST_FILENAME]: {
                        content: JSON.stringify(dataToSave, null, 2)
                    }
                }
            };

            try {
                const response = await fetch(`https://api.github.com/gists/${GIST_ID}`, {
                    method: 'PATCH',
                    headers: {
                        'Authorization': `token ${PAT}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    throw new Error(`GitHub API error: ${response.statusText}`);
                }
                console.log("æ•¸æ“šå·²æˆåŠŸå„²å­˜åˆ° Gistã€‚");
            } catch (error) {
                console.error("å„²å­˜ Gist è³‡æ–™å¤±æ•—:", error);
                alert("æ•¸æ“šå„²å­˜åˆ°é›²ç«¯å¤±æ•—ï¼è«‹æª¢æŸ¥æ‚¨çš„ GIST_ID å’Œ PAT æ˜¯å¦æ­£ç¢ºã€‚");
            }
        }
        
        // åˆå§‹åŒ–é è¨­è¨­å®š
        function initDefaultSettings() {
             appSettings = {
                // è–ªè³‡çµæ§‹
                baseSalary: 45500, dutyAllowance: 0, trafficAllowance: 0, maintenanceAllowance: 0, stockCompanyIncome: 0,
                laborInsurance: 0, healthInsurance: 0, stockCompanyDeduct: 0, stockSelfDeduct: 0,
                // çµç®—æ—¥
                cutoff1: 22, cutoff2: 25, cutoff3: 25, cutoff4: 27, cutoff5: 27, cutoff6: 26, 
                cutoff7: 29, cutoff8: 28, cutoff9: 25, cutoff10: 29, cutoff11: 27, cutoff12: 31,
                // çµç®—æœˆä»½
                payMonthSelect: new Date().getMonth() + 1,
                // On Call
                onCallCount: 0,
                // é¡¯ç¤ºè¨­å®š (é è¨­å…¨é–‹)
                chkShowMonthlyOT: true, chkShowMonthlyMeal: true, chkShowSalary: true,
                fieldMonthlyTotalHours: true, fieldMonthly133: true, fieldMonthly166: true, fieldMonthly200: true, fieldMonthly267: true, fieldMonthlyCompHours: true, fieldMonthlyCompCash: true, fieldMonthlyOTPay: true,
                fieldMonthlyMealCount: true, fieldMonthlyMealFee: true,
                fieldSalaryFixIn: true, fieldSalaryFixOut: true, fieldSalaryTotalHours: true, fieldSalary133: true, fieldSalary166: true, fieldSalary200: true, fieldSalary267: true, fieldSalaryOTPay: true, fieldSalaryCompCash: true, fieldSalaryOncallCount: true, fieldSalaryOncallAmount: true, fieldSalarySickH: true, fieldSalarySickDed: true, fieldSalaryPersonalH: true, fieldSalaryPersonalDed: true, fieldSalaryTotalIncome: true
            };
            applySettings();
        }

        // æ‡‰ç”¨è¨­å®šåˆ°ä»‹é¢
        function applySettings() {
            // è–ªè³‡çµæ§‹
            document.getElementById("baseSalary").value = appSettings.baseSalary || 45500;
            document.getElementById("dutyAllowance").value = appSettings.dutyAllowance || 0;
            document.getElementById("trafficAllowance").value = appSettings.trafficAllowance || 0;
            document.getElementById("maintenanceAllowance").value = appSettings.maintenanceAllowance || 0;
            document.getElementById("stockCompanyIncome").value = appSettings.stockCompanyIncome || 0;
            document.getElementById("laborInsurance").value = appSettings.laborInsurance || 0;
            document.getElementById("healthInsurance").value = appSettings.healthInsurance || 0;
            document.getElementById("stockCompanyDeduct").value = appSettings.stockCompanyDeduct || 0;
            document.getElementById("stockSelfDeduct").value = appSettings.stockSelfDeduct || 0;

            // çµç®—æ—¥
            for (let i = 1; i <= 12; i++) {
                document.getElementById(`cutoff${i}`).value = appSettings[`cutoff${i}`] || 25;
            }
            document.getElementById("payMonthSelect").value = appSettings.payMonthSelect || (new Date().getMonth() + 1);
            
            // On Call
            document.getElementById("onCallCount").value = appSettings.onCallCount || 0;

            // é¡¯ç¤ºè¨­å®š
            const checkboxIds = Object.keys(appSettings).filter(key => key.startsWith('chk') || key.startsWith('field'));
            checkboxIds.forEach(id => {
                const checkbox = document.getElementById(id);
                if (checkbox) {
                    checkbox.checked = appSettings[id] !== undefined ? appSettings[id] : true;
                }
            });

            // è§¸ç™¼é‡æ–°è¨ˆç®—å’Œå¯è¦‹æ€§æ›´æ–°
            updateFixedIncomeOutgo();
            updatePayPeriodSummary();
            updateVisibility();
        }

        // å¾ä»‹é¢æ”¶é›†è¨­å®š
        function collectSettings() {
            // è–ªè³‡çµæ§‹
            appSettings.baseSalary = parseFloat(document.getElementById("baseSalary").value) || 0;
            appSettings.dutyAllowance = parseFloat(document.getElementById("dutyAllowance").value) || 0;
            appSettings.trafficAllowance = parseFloat(document.getElementById("trafficAllowance").value) || 0;
            appSettings.maintenanceAllowance = parseFloat(document.getElementById("maintenanceAllowance").value) || 0;
            appSettings.stockCompanyIncome = parseFloat(document.getElementById("stockCompanyIncome").value) || 0;
            appSettings.laborInsurance = parseFloat(document.getElementById("laborInsurance").value) || 0;
            appSettings.healthInsurance = parseFloat(document.getElementById("healthInsurance").value) || 0;
            appSettings.stockCompanyDeduct = parseFloat(document.getElementById("stockCompanyDeduct").value) || 0;
            appSettings.stockSelfDeduct = parseFloat(document.getElementById("stockSelfDeduct").value) || 0;
            
            // çµç®—æ—¥/æœˆä»½/On Call
            for (let i = 1; i <= 12; i++) {
                appSettings[`cutoff${i}`] = parseInt(document.getElementById(`cutoff${i}`).value, 10) || 25;
            }
            appSettings.payMonthSelect = parseInt(document.getElementById("payMonthSelect").value, 10) || 1;
            appSettings.onCallCount = parseInt(document.getElementById("onCallCount").value, 10) || 0;

            // é¡¯ç¤ºè¨­å®š
            const checkboxIds = [
                'chkShowMonthlyOT', 'chkShowMonthlyMeal', 'chkShowSalary',
                'fieldMonthlyTotalHours', 'fieldMonthly133', 'fieldMonthly166', 'fieldMonthly200', 'fieldMonthly267', 'fieldMonthlyCompHours', 'fieldMonthlyCompCash', 'fieldMonthlyOTPay',
                'fieldMonthlyMealCount', 'fieldMonthlyMealFee',
                'fieldSalaryFixIn', 'fieldSalaryFixOut', 'fieldSalaryTotalHours', 'fieldSalary133', 'fieldSalary166', 'fieldSalary200', 'fieldSalary267', 'fieldSalaryOTPay', 'fieldSalaryCompCash', 'fieldSalaryOncallCount', 'fieldSalaryOncallAmount', 'fieldSalarySickH', 'fieldSalarySickDed', 'fieldSalaryPersonalH', 'fieldSalaryPersonalDed', 'fieldSalaryTotalIncome'
            ];
            checkboxIds.forEach(id => {
                const checkbox = document.getElementById(id);
                if (checkbox) {
                    appSettings[id] = checkbox.checked;
                }
            });
        }

        // æ›´æ–°å„å€å¡Šå¯è¦‹æ€§
        function updateVisibility() {
            // ä¸»å€å¡Š
            document.getElementById('sectionMonthlyOT').style.display = appSettings.chkShowMonthlyOT ? 'block' : 'none';
            document.getElementById('sectionMonthlyMeal').style.display = appSettings.chkShowMonthlyMeal ? 'block' : 'none';
            document.getElementById('sectionSalary').style.display = appSettings.chkShowSalary ? 'block' : 'none';

            // æœˆçµ±è¨ˆ
            document.getElementById('itemMonthlyTotalHours').style.display = appSettings.fieldMonthlyTotalHours ? 'block' : 'none';
            document.getElementById('itemMonthly133').style.display = appSettings.fieldMonthly133 ? 'block' : 'none';
            document.getElementById('itemMonthly166').style.display = appSettings.fieldMonthly166 ? 'block' : 'none';
            document.getElementById('itemMonthly200').style.display = appSettings.fieldMonthly200 ? 'block' : 'none';
            document.getElementById('itemMonthly267').style.display = appSettings.fieldMonthly267 ? 'block' : 'none';
            document.getElementById('itemMonthlyCompHours').style.display = appSettings.fieldMonthlyCompHours ? 'block' : 'none';
            document.getElementById('itemMonthlyCompCash').style.display = appSettings.fieldMonthlyCompCash ? 'block' : 'none';
            document.getElementById('itemMonthlyOTPay').style.display = appSettings.fieldMonthlyOTPay ? 'block' : 'none';
            document.getElementById('itemMonthlyMealCount').style.display = appSettings.fieldMonthlyMealCount ? 'block' : 'none';
            document.getElementById('itemMonthlyMealFee').style.display = appSettings.fieldMonthlyMealFee ? 'block' : 'none';

            // è–ªè³‡è©¦ç®—
            document.getElementById('itemSalaryFixIn').style.display = appSettings.fieldSalaryFixIn ? 'block' : 'none';
            document.getElementById('itemSalaryFixOut').style.display = appSettings.fieldSalaryFixOut ? 'block' : 'none';
            document.getElementById('itemSalaryTotalHours').style.display = appSettings.fieldSalaryTotalHours ? 'block' : 'none';
            document.getElementById('itemSalary133').style.display = appSettings.fieldSalary133 ? 'block' : 'none';
            document.getElementById('itemSalary166').style.display = appSettings.fieldSalary166 ? 'block' : 'none';
            document.getElementById('itemSalary200').style.display = appSettings.fieldSalary200 ? 'block' : 'none';
            document.getElementById('itemSalary267').style.display = appSettings.fieldSalary267 ? 'block' : 'none';
            document.getElementById('itemSalaryOTPay').style.display = appSettings.fieldSalaryOTPay ? 'block' : 'none';
            document.getElementById('itemSalaryCompCash').style.display = appSettings.fieldSalaryCompCash ? 'block' : 'none';
            document.getElementById('itemSalaryOncallCount').style.display = appSettings.fieldSalaryOncallCount ? 'block' : 'none';
            document.getElementById('itemSalaryOncallAmount').style.display = appSettings.fieldSalaryOncallAmount ? 'block' : 'none';
            document.getElementById('itemSalarySickH').style.display = appSettings.fieldSalarySickH ? 'block' : 'none';
            document.getElementById('itemSalarySickDed').style.display = appSettings.fieldSalarySickDed ? 'block' : 'none';
            document.getElementById('itemSalaryPersonalH').style.display = appSettings.fieldSalaryPersonalH ? 'block' : 'none';
            document.getElementById('itemSalaryPersonalDed').style.display = appSettings.fieldSalaryPersonalDed ? 'block' : 'none';
            document.getElementById('itemSalaryTotalIncome').style.display = appSettings.fieldSalaryTotalIncome ? 'block' : 'none';
        }


        // ===============================================
        // =================== åŒ¯å‡ºåŠŸèƒ½ ==================
        // ===============================================

        function exportJSON() {
            collectSettings();
            const dataToExport = {
                dayData: dayData,
                appSettings: appSettings,
                timestamp: new Date().toISOString()
            };
            const jsonString = JSON.stringify(dataToExport, null, 2);
            const blob = new Blob([jsonString], { type: "application/json" });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `xunde_overtime_data_${currentYear}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        document.getElementById('importJsonInput').addEventListener('change', (event) => {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const importedData = JSON.parse(e.target.result);
                    if (importedData.dayData) {
                        dayData = importedData.dayData;
                    }
                    if (importedData.appSettings) {
                        appSettings = importedData.appSettings;
                        applySettings();
                    }
                    buildMonthTable(); 
                    saveState();
                    alert("åŒ¯å…¥æˆåŠŸï¼æ•¸æ“šå·²åŒæ­¥åˆ°é›²ç«¯ Gistã€‚");
                } catch (error) {
                    alert("åŒ¯å…¥å¤±æ•—ï¼šæª”æ¡ˆæ ¼å¼éŒ¯èª¤ã€‚");
                    console.error("Error parsing imported JSON:", error);
                }
            };
            reader.readAsText(file);
        });

        function exportCSV() {
            let csv = "æ—¥æœŸ,æ˜ŸæœŸ,é¡å‹,å‡åˆ¥,ä¸Šç­,ä¸‹ç­,1.34h,1.67h,2.0h,2.67h,è£œä¼‘h,åŠ ç­è²»,èª¤é¤æ•¸,èª¤é¤è²»\n";
            
            const startOfYear = new Date(currentYear, 0, 1);
            const endOfYear = new Date(currentYear, 11, 31);

            let currentDate = new Date(startOfYear);
            while (currentDate <= endOfYear) {
                const dateKey = `${currentDate.getFullYear()}-${String(currentDate.getMonth() + 1).padStart(2, '0')}-${String(currentDate.getDate()).padStart(2, '0')}`;
                const data = dayData[dateKey] || { start: "", end: "", leaveType: "normal", otDetails: { h134: 0, h167: 0, h200: 0, h267: 0, hComp: 0, otPay: 0, mealCount: 0, mealFee: 0 } };

                const weekday = currentDate.getDay(); // 0=Sunday, 6=Saturday
                const weekdayName = ["æ—¥", "ä¸€", "äºŒ", "ä¸‰", "å››", "äº”", "å…­"][weekday];
                const isWeekend = (weekday === 0 || weekday === 6);
                const isHoliday = isNationalHoliday(currentDate);

                let dayTypeDisplay = "å¹³æ—¥";
                if (isHoliday) dayTypeDisplay = "åœ‹å®šå‡æ—¥";
                else if (isWeekend) dayTypeDisplay = (weekday === 0) ? "é€±æ—¥" : "é€±å…­";

                // ç¢ºä¿ otDetails æ˜¯æœ€æ–°çš„
                const ot = data.otDetails || calculateOvertime(dateKey, data.start, data.end, isWeekend, isHoliday);
                
                const leaveText = {
                    "normal": "æ­£å¸¸å‡ºå‹¤", "annual": "ç‰¹ä¼‘", "comp": "è£œä¼‘", "sick": "ç—…å‡", "personal": "äº‹å‡"
                }[data.leaveType];

                const row = [
                    dateKey,
                    weekdayName,
                    dayTypeDisplay,
                    leaveText,
                    data.start,
                    data.end,
                    fmtNumber(ot.h134),
                    fmtNumber(ot.h167),
                    fmtNumber(ot.h200),
                    fmtNumber(ot.h267),
                    fmtNumber(ot.hComp),
                    Math.round(ot.otPay),
                    ot.mealCount,
                    Math.round(ot.mealFee)
                ].map(item => `"${item}"`).join(",");
                
                csv += row + "\n";
                currentDate.setDate(currentDate.getDate() + 1);
            }

            const blob = new Blob([new Uint8Array([0xEF, 0xBB, 0xBF]), csv], { type: 'text/csv;charset=utf-8;' }); // Add BOM for Chinese support in Excel
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `è¿…å¾—åŠ ç­æ˜ç´°_${currentYear}.csv`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        function exportPDF() {
            window.print();
        }

        // ===============================================
        // =================== æ¢—åœ–åŠŸèƒ½ ==================
        // ===============================================
        
        function getRandomMeme(category) {
            let filteredList = memeList;
            if (category !== 'all') {
                filteredList = memeList.filter(meme => meme.tag === category);
            }
            if (filteredList.length === 0) return { title: "æ¢—åœ–åº«ç©ºäº†", subtitle: "é€™å¹´é ­é€£æ¢—åœ–éƒ½è¦åŠ ç­", tag: "all" };
            const randomIndex = Math.floor(Math.random() * filteredList.length);
            return filteredList[randomIndex];
        }

        function updateMeme() {
            const category = document.getElementById('memeCategory').value;
            const meme = getRandomMeme(category);
            document.getElementById('memeTitle').textContent = meme.title;
            document.getElementById('memeSubtitle').textContent = meme.subtitle;
        }

        // ===============================================
        // =================== åˆå§‹åŒ– ====================
        // ===============================================

        function setupEventListeners() {
            // è¨­å®šé–‹é—œ
            document.getElementById("btnSettings").addEventListener('click', () => {
                document.getElementById("settingsPanel").classList.toggle("hidden");
            });

            // è–ªè³‡è¨­å®š input ç›£è½
            const salaryInputs = ["baseSalary", "dutyAllowance", "trafficAllowance", "maintenanceAllowance", "stockCompanyIncome", "laborInsurance", "healthInsurance", "stockCompanyDeduct", "stockSelfDeduct"];
            salaryInputs.forEach(id => {
                document.getElementById(id).addEventListener('change', recalcAll);
            });
            
            // çµç®—æ—¥ input ç›£è½
            for(let i=1; i<=12; i++) {
                document.getElementById(`cutoff${i}`).addEventListener('change', recalcAll);
            }

            // On Call input ç›£è½
            document.getElementById("onCallCount").addEventListener('change', recalcAll);
            
            // é¡¯ç¤ºè¨­å®š checkbox ç›£è½
            const checkboxIds = [
                'chkShowMonthlyOT', 'chkShowMonthlyMeal', 'chkShowSalary',
                'fieldMonthlyTotalHours', 'fieldMonthly133', 'fieldMonthly166', 'fieldMonthly200', 'fieldMonthly267', 'fieldMonthlyCompHours', 'fieldMonthlyCompCash', 'fieldMonthlyOTPay',
                'fieldMonthlyMealCount', 'fieldMonthlyMealFee',
                'fieldSalaryFixIn', 'fieldSalaryFixOut', 'fieldSalaryTotalHours', 'fieldSalary133', 'fieldSalary166', 'fieldSalary200', 'fieldSalary267', 'fieldSalaryOTPay', 'fieldSalaryCompCash', 'fieldSalaryOncallCount', 'fieldSalaryOncallAmount', 'fieldSalarySickH', 'fieldSalarySickDed', 'fieldSalaryPersonalH', 'fieldSalaryPersonalDed', 'fieldSalaryTotalIncome'
            ];
            checkboxIds.forEach(id => {
                document.getElementById(id).addEventListener('change', (e) => {
                    appSettings[id] = e.target.checked;
                    updateVisibility();
                    saveState();
                });
            });

            // æ¢—åœ–åˆ‡æ›
            document.getElementById('btnChangeMeme').addEventListener('click', updateMeme);
            document.getElementById('memeCategory').addEventListener('change', updateMeme);
            
            // å¹´ä»½è¼¸å…¥æ¡†
            document.getElementById("yearInput").addEventListener('change', buildMonthTable);
        }

        // å•Ÿå‹•æ‡‰ç”¨
        setupEventListeners();
        updateMeme();
        loadState(); // å„ªå…ˆè¼‰å…¥ Gist æ•¸æ“šä¸¦åˆå§‹åŒ–è¡¨æ ¼
    </script>
</body>
</html>