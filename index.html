<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <title>è¿…å¾—-å°è³‡æ—çš„è¡€æ±—éŒ¢ (é›²ç«¯åŒæ­¥ç‰ˆ)</title>
  <style>
    :root {
      --primary: #1976d2;
      --primary-soft: #e3f2fd;
      --bg: #f3f4f6;
      --card-bg: #ffffff;
      --border: #e0e0e0;
      --text-main: #1f2933;
      --text-sub: #6b7280;
      --danger: #e53935;
      --accent: #ffb300;
      --warn: #fb923c;
    }
    * { box-sizing: border-box; }
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      margin: 0;
      padding: 16px;
      background: radial-gradient(circle at top, #e3f2fd, #f3f4f6 45%);
      color: var(--text-main);
    }
    .page {
      max-width: 1200px;
      margin: 0 auto;
    }
    .header-row {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 6px;
      margin-bottom: 12px;
    }
    h1 {
      margin: 0;
      font-size: 36px;
      font-weight: 800;
      text-align: center;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 6px;
    }
    h1 span.tag {
      font-size: 12px;
      padding: 3px 10px;
      border-radius: 999px;
      background: var(--primary-soft);
      color: var(--primary);
      border: 1px solid #bbdefb;
    }
    h2 {
      margin: 0 0 8px;
      font-size: 18px;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 6px;
    }
    h2::before {
      content: "";
      width: 4px;
      height: 18px;
      border-radius: 999px;
      background: var(--primary);
      display: inline-block;
    }
    .card {
      background: var(--card-bg);
      padding: 12px 16px 14px;
      border-radius: 12px;
      box-shadow: 0 8px 20px rgba(15, 23, 42, 0.08);
      margin-bottom: 16px;
      border: 1px solid rgba(148, 163, 184, 0.35);
    }
    .flex-row {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      align-items: center;
    }
    label {
      margin-right: 4px;
      font-size: 13px;
      color: var(--text-sub);
    }
    input[type="number"] {
      width: 100px;
      padding: 4px 6px;
      font-size: 12px;
      border-radius: 6px;
      border: 1px solid var(--border);
      background: #f9fafb;
    }
    input[type="number"]:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 1px rgba(25,118,210,0.2);
      background: #ffffff;
    }
    select {
      font-size: 12px;
      padding: 3px 6px;
      border-radius: 6px;
      border: 1px solid var(--border);
      background: #f9fafb;
    }
    select:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 1px rgba(25,118,210,0.2);
      background: #ffffff;
    }
    .btn {
      padding: 5px 12px;
      border-radius: 999px;
      border: none;
      background: var(--primary);
      color: #fff;
      cursor: pointer;
      font-size: 12px;
      display: inline-flex;
      align-items: center;
      gap: 4px;
      box-shadow: 0 4px 10px rgba(25,118,210,0.4);
    }
    .btn span.icon { font-size: 13px; }
    .btn:active {
      transform: translateY(1px);
      box-shadow: 0 2px 6px rgba(25,118,210,0.4);
    }
    .btn-icon {
      width: 40px;
      height: 40px;
      border-radius: 999px;
      border: none;
      background: #ffffff;
      box-shadow: 0 3px 8px rgba(15, 23, 42, 0.15);
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      font-size: 20px;
      color: #4b5563;
    }
    .btn-icon:active { transform: translateY(1px); }
    .note {
      font-size: 11px;
      color: var(--text-sub);
      margin-top: 4px;
      line-height: 1.5;
    }
    .summary-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 8px;
      font-size: 13px;
      margin-top: 8px;
    }
    .summary-item {
      background: #f9fafb;
      border-radius: 10px;
      padding: 6px 8px;
      border: 1px solid var(--border);
    }
    .summary-item strong {
      display: block;
      font-size: 12px;
      color: var(--text-sub);
      margin-bottom: 2px;
    }
    .summary-item span.value {
      font-size: 15px;
      font-weight: 600;
      color: var(--primary);
    }
    .summary-item span.value.negative { color: var(--danger); }
    .cutoff-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(135px, 1fr));
      gap: 6px;
      margin-top: 8px;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      background: var(--card-bg);
    }
    th, td {
      border: 1px solid #e5e7eb;
      padding: 4px 6px;
      font-size: 12px;
      text-align: center;
      white-space: nowrap;
    }
    th {
      background: #f1f5f9;
      position: sticky;
      top: 0;
      z-index: 2;
    }
    tbody tr:nth-child(even):not(.weekend-row):not(.national-holiday-row) {
      background: #fdfdfd;
    }
    .holiday-date {
      color: var(--danger);
      font-weight: 600;
    }
    .weekday-row { background-color: #fffef5; }
    .weekend-row { background-color: #e8f4ff; }
    .national-holiday-row { background-color: #ffebee; }
    .scroll-card {
      max-height: 480px;
      overflow: auto;
    }
    .invalid-row {
      outline: 2px solid var(--warn);
      outline-offset: -2px;
    }
    .settings-panel.hidden { display: none; }
    .settings-title {
      font-size: 13px;
      font-weight: 600;
      margin-top: 2px;
      margin-bottom: 4px;
      color: #111827;
    }

    /* æ¢—åœ–å¡ç‰‡ */
    .meme-card {
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
      background: linear-gradient(135deg, #1e293b, #0f172a);
      color: #f9fafb;
      border-radius: 16px;
      padding: 12px 16px;
      box-shadow: 0 10px 24px rgba(15,23,42,0.5);
      margin-bottom: 14px;
      border: 1px solid rgba(148,163,184,0.4);
    }
    .meme-text-block {
      flex: 1;
      min-width: 0;
    }
    .meme-title {
      font-size: 26px;
      font-weight: 800;
      margin-bottom: 6px;
    }
    .meme-subtitle {
      font-size: 15px;
      opacity: 0.9;
    }
    .meme-btn-area {
      display: flex;
      align-items: center;
      gap: 8px;
    }
  </style>
</head>
<body>
  <div class="page">
    <div id="memeBar" class="card meme-card">
      <div class="meme-text-block">
        <div id="memeTitle" class="meme-title">æ¢—è¼‰å…¥ä¸­...</div>
        <div id="memeSubtitle" class="meme-subtitle">ä»Šå¤©ä¹Ÿè¦åŠªåŠ›å®ˆè­·è‡ªå·±çš„è¡€æ±—éŒ¢ã€‚</div>
      </div>
      <div class="meme-btn-area">
        <select id="memeCategory">
          <option value="all">å…¨éƒ¨</option>
          <option value="work">ä¸Šç­ / åŠ ç­</option>
          <option value="life">ç”Ÿæ´» / å°åŠ‡å ´</option>
        </select>
        <button id="btnChangeMeme" class="btn">
          <span class="icon">ğŸ²</span> æ›ä¸€å¼µæ¢—
        </button>
      </div>
    </div>

    <div class="header-row">
      <h1>
        è¿…å¾—-å°è³‡æ—çš„è¡€æ±—éŒ¢
        <span class="tag">åŠ ç­ç´€éŒ„ãƒ»è–ªè³‡è©¦ç®—ãƒ»çµç®—æ—¥ï¼ˆGisté›²ç«¯åŒæ­¥ï¼‰</span>
      </h1>
      <button id="btnSettings" class="btn-icon" title="é–‹å•Ÿ / é—œé–‰è¨­å®š">
        âš™
      </button>
    </div>

    <div id="settingsPanel" class="card settings-panel hidden">
      <h2>è¨­å®š</h2>

      <div class="settings-block">
        <div class="settings-title">è–ªè³‡çµæ§‹</div>
        <div class="flex-row">
          <div>
            <label>æœ¬è–ª</label>
            <input type="number" id="baseSalary" value="45500" step="1">
          </div>
          <div>
            <label>è·å‹™åŠ çµ¦</label>
            <input type="number" id="dutyAllowance" value="0" step="1">
          </div>
          <div>
            <label>äº¤é€šæ´¥è²¼</label>
            <input type="number" id="trafficAllowance" value="0" step="1">
          </div>
          <div>
            <label>ç¶­ä¿®æ´¥è²¼</label>
            <input type="number" id="maintenanceAllowance" value="0" step="1">
          </div>
          <div>
            <label>æŒè‚¡ä¿¡è¨—å…¬æï¼ˆæ”¶å…¥ï¼‰</label>
            <input type="number" id="stockCompanyIncome" value="0" step="1">
          </div>
        </div>
        <div class="flex-row" style="margin-top:8px;">
          <div>
            <label>å‹ä¿è²»</label>
            <input type="number" id="laborInsurance" value="0" step="1">
          </div>
          <div>
            <label>å¥ä¿è²»</label>
            <input type="number" id="healthInsurance" value="0" step="1">
          </div>
          <div>
            <label>æŒè‚¡ä¿¡è¨—å…¬æï¼ˆæ”¯å‡ºï¼‰</label>
            <input type="number" id="stockCompanyDeduct" value="0" step="1">
          </div>
          <div>
            <label>æŒè‚¡ä¿¡è¨—è‡ªæ</label>
            <input type="number" id="stockSelfDeduct" value="0" step="1">
          </div>
          <button class="btn" onclick="recalcAll()">
            <span class="icon">âŸ³</span> å¥—ç”¨è–ªè³‡çµæ§‹ä¸¦é‡æ–°è¨ˆç®—
          </button>
        </div>
        <div class="summary-grid">
          <div class="summary-item">
            <strong>åŠ ç­åŸºç¤æ™‚è–ª</strong>
            <span id="hourlyBaseDisplay" class="value">0</span>
            <div class="note">= (æœ¬è–ª + è·å‹™åŠ çµ¦ + äº¤é€šæ´¥è²¼) Ã· 240ï¼ˆå››æ¨äº”å…¥ç‚ºæ•´æ•¸å…ƒï¼‰</div>
          </div>
          <div class="summary-item">
            <strong>å›ºå®šæ”¶å…¥å°è¨ˆ</strong>
            <span id="fixedIncomeDisplay" class="value">0</span>
          </div>
          <div class="summary-item">
            <strong>å›ºå®šæ”¯å‡ºå°è¨ˆ</strong>
            <span id="fixedOutgoDisplay" class="value">0</span>
          </div>
        </div>
      </div>

      <div class="settings-block" style="margin-top:12px;">
        <div class="settings-title">çµç®—æ—¥è¨­å®š & è–ªè³‡çµç®—æœˆä»½</div>
        <div class="note">
          çµç®—æœˆä»½ M çš„åŠ ç­çµ±è¨ˆå€é–“ =ã€Œå‰ä¸€å€‹æœˆä»½çš„çµç®—æ—¥ +1 å¤©ã€åˆ°ã€Œæœ¬æœˆä»½çš„çµç®—æ—¥ã€ã€‚<br>
          ä¾‹ï¼š1 æœˆçµç®—è‡³ 1/22 â†’ 1/23ï½1/31 ç®—é€² 2 æœˆè–ªè³‡ï¼›2 æœˆçµç®—è‡³ 2/25 â†’ 2/26ï½2/28 ç®—é€² 3 æœˆè–ªè³‡ã€‚
        </div>
        <div class="cutoff-grid">
          <div><label>1 æœˆçµç®—æ—¥</label><input type="number" id="cutoff1" value="22" min="1" max="31"></div>
          <div><label>2 æœˆçµç®—æ—¥</label><input type="number" id="cutoff2" value="25" min="1" max="31"></div>
          <div><label>3 æœˆçµç®—æ—¥</label><input type="number" id="cutoff3" value="25" min="1" max="31"></div>
          <div><label>4 æœˆçµç®—æ—¥</label><input type="number" id="cutoff4" value="27" min="1" max="31"></div>
          <div><label>5 æœˆçµç®—æ—¥</label><input type="number" id="cutoff5" value="27" min="1" max="31"></div>
          <div><label>6 æœˆçµç®—æ—¥</label><input type="number" id="cutoff6" value="26" min="1" max="31"></div>
          <div><label>7 æœˆçµç®—æ—¥</label><input type="number" id="cutoff7" value="29" min="1" max="31"></div>
          <div><label>8 æœˆçµç®—æ—¥</label><input type="number" id="cutoff8" value="28" min="1" max="31"></div>
          <div><label>9 æœˆçµç®—æ—¥</label><input type="number" id="cutoff9" value="25" min="1" max="31"></div>
          <div><label>10 æœˆçµç®—æ—¥</label><input type="number" id="cutoff10" value="29" min="1" max="31"></div>
          <div><label>11 æœˆçµç®—æ—¥</label><input type="number" id="cutoff11" value="27" min="1" max="31"></div>
          <div><label>12 æœˆçµç®—æ—¥</label><input type="number" id="cutoff12" value="31" min="1" max="31"></div>
        </div>
        <div class="flex-row" style="margin-top:10px;">
          <div>
            <label for="payMonthSelect">è–ªè³‡çµç®—æœˆä»½</label>
            <select id="payMonthSelect" onchange="updatePayPeriodSummary(); saveState();">
              <option value="1">1 æœˆ</option>
              <option value="2">2 æœˆ</option>
              <option value="3">3 æœˆ</option>
              <option value="4">4 æœˆ</option>
              <option value="5">5 æœˆ</option>
              <option value="6">6 æœˆ</option>
              <option value="7">7 æœˆ</option>
              <option value="8">8 æœˆ</option>
              <option value="9">9 æœˆ</option>
              <option value="10">10 æœˆ</option>
              <option value="11">11 æœˆ</option>
              <option value="12">12 æœˆ</option>
            </select>
          </div>
          <button class="btn" onclick="updatePayPeriodSummary(); saveState();">
            <span class="icon">ğŸ“…</span> é‡æ–°è¨ˆç®—çµç®—å€é–“
          </button>
          <span id="payPeriodLabel" class="note"></span>
        </div>
      </div>

      <div class="settings-block" style="margin-top:12px;">
        <div class="settings-title">ä¸»é é¡¯ç¤ºè¨­å®š</div>
        <div>
          <label><input type="checkbox" id="chkShowMonthlyOT" checked> é¡¯ç¤ºã€Œæœ¬æœˆåŠ ç­çµ±è¨ˆã€</label>
        </div>
        <div>
          <label><input type="checkbox" id="chkShowMonthlyMeal" checked> é¡¯ç¤ºã€Œæœ¬æœˆèª¤é¤çµ±è¨ˆã€</label>
        </div>
        <div>
          <label><input type="checkbox" id="chkShowSalary" checked> é¡¯ç¤ºã€Œè–ªè³‡è©¦ç®—ï¼ˆçµç®—å€é–“ï¼‰ã€</label>
        </div>

        <div class="note" style="margin-top:6px;">
          ä¸‹æ–¹å¯å€‹åˆ¥é¸æ“‡æ¯å€‹å€å¡Šå…§è¦é¡¯ç¤ºçš„æ¬„ä½ã€‚
        </div>

        <div style="margin-top:6px; font-size:12px; font-weight:600;">ä¸€ã€æœ¬æœˆåŠ ç­çµ±è¨ˆ æ¬„ä½</div>
        <div style="font-size:12px;">
          <label><input type="checkbox" id="fieldMonthlyTotalHours" checked> ç¸½åŠ ç­æ™‚æ•¸</label>
          <label><input type="checkbox" id="fieldMonthly133" checked> 1.34 ç¸½æ™‚æ•¸</label>
          <label><input type="checkbox" id="fieldMonthly166" checked> 1.67 ç¸½æ™‚æ•¸</label>
          <label><input type="checkbox" id="fieldMonthly200" checked> 2.0 ç¸½æ™‚æ•¸</label>
          <label><input type="checkbox" id="fieldMonthly267" checked> 2.67 ç¸½æ™‚æ•¸</label>
          <label><input type="checkbox" id="fieldMonthlyCompHours" checked> ç¸½è£œä¼‘æ™‚æ•¸</label>
          <label><input type="checkbox" id="fieldMonthlyCompCash" checked> è£œä¼‘æŠ˜ç¾é‡‘é¡</label>
          <label><input type="checkbox" id="fieldMonthlyOTPay" checked> ç¸½åŠ ç­è²»</label>
        </div>

        <div style="margin-top:6px; font-size:12px; font-weight:600;">äºŒã€æœ¬æœˆèª¤é¤çµ±è¨ˆ æ¬„ä½</div>
        <div style="font-size:12px;">
          <label><input type="checkbox" id="fieldMonthlyMealCount" checked> ç¸½èª¤é¤æ•¸</label>
          <label><input type="checkbox" id="fieldMonthlyMealFee" checked> ç¸½èª¤é¤è²»</label>
        </div>

        <div style="margin-top:6px; font-size:12px; font-weight:600;">ä¸‰ã€è–ªè³‡è©¦ç®—ï¼ˆçµç®—å€é–“ï¼‰æ¬„ä½</div>
        <div style="font-size:12px;">
          <label><input type="checkbox" id="fieldSalaryFixIn" checked> å›ºå®šæ”¶å…¥å°è¨ˆ</label>
          <label><input type="checkbox" id="fieldSalaryFixOut" checked> å›ºå®šæ”¯å‡ºå°è¨ˆ</label>
          <label><input type="checkbox" id="fieldSalaryTotalHours" checked> ç¸½åŠ ç­æ™‚æ•¸</label>
          <label><input type="checkbox" id="fieldSalary133" checked> 1.34 æ™‚æ•¸</label>
          <label><input type="checkbox" id="fieldSalary166" checked> 1.67 æ™‚æ•¸</label>
          <label><input type="checkbox" id="fieldSalary200" checked> 2.0 æ™‚æ•¸</label>
          <label><input type="checkbox" id="fieldSalary267" checked> 2.67 æ™‚æ•¸</label>
          <label><input type="checkbox" id="fieldSalaryOTPay" checked> åŠ ç­è²»</label>
          <label><input type="checkbox" id="fieldSalaryCompCash" checked> è£œä¼‘æŠ˜ç¾</label>
          <label><input type="checkbox" id="fieldSalaryOncallCount" checked> on call æ¬¡æ•¸</label>
          <label><input type="checkbox" id="fieldSalaryOncallAmount" checked> on call é‡‘é¡</label>
          <label><input type="checkbox" id="fieldSalarySickH" checked> ç—…å‡æ™‚æ•¸</label>
          <label><input type="checkbox" id="fieldSalarySickDed" checked> ç—…å‡æ‰£æ¬¾</label>
          <label><input type="checkbox" id="fieldSalaryPersonalH" checked> äº‹å‡æ™‚æ•¸</label>
          <label><input type="checkbox" id="fieldSalaryPersonalDed" checked> äº‹å‡æ‰£æ¬¾</label>
          <label><input type="checkbox" id="fieldSalaryTotalIncome" checked> ç¸½æ”¶å…¥</label>
        </div>
      </div>

      <div class="settings-block" style="margin-top:12px;">
        <div class="settings-title">è³‡æ–™å‚™ä»½ / åŒ¯å‡º</div>
        <div class="flex-row">
          <button class="btn" onclick="exportJSON()">
            <span class="icon">ğŸ’¾</span> åŒ¯å‡ºè¨­å®š(JSON)
          </button>
          <label class="btn" for="importJsonInput">
            <span class="icon">ğŸ“¥</span> åŒ¯å…¥è¨­å®š(JSON)
          </label>
          <input type="file" id="importJsonInput" accept=".json,application/json" style="display:none;">
          <button class="btn" onclick="exportCSV()">
            <span class="icon">ğŸ“Š</span> åŒ¯å‡ºå…¨å¹´æ˜ç´°(CSV/Excel)
          </button>
          <button class="btn" onclick="exportPDF()">
            <span class="icon">ğŸ–¨</span> åŒ¯å‡º PDF
          </button>
        </div>
        <div class="note">
          JSONï¼šå®Œæ•´å‚™ä»½æ‰€æœ‰å¹´ä»½çš„æ‰“å¡ã€åŠ ç­ã€è–ªè³‡èˆ‡é¡¯ç¤ºè¨­å®šï¼ˆä¸å« Gist å¯†é‘°ï¼‰ã€‚<br>
          CSVï¼šè¼¸å‡ºç›®å‰å¹´ä»½çš„å…¨å¹´æ¯æ—¥æ˜ç´°ï¼Œå¯ç”¨ Excel é–‹å•Ÿã€‚<br>
          PDFï¼šå‘¼å«ç€è¦½å™¨åˆ—å°ï¼Œé¸ã€Œå¦å­˜ç‚º PDFã€å³å¯ã€‚<br>
          **æ³¨æ„ï¼š** åŒ¯å…¥ JSON æœƒè¦†è“‹é›²ç«¯ Gist ä¸Šçš„æ‰€æœ‰è³‡æ–™ã€‚
        </div>
      </div>
    </div>

    <div class="card">
      <h2>æ—¥æ›†æœˆä»½é¸æ“‡</h2>
      <div class="flex-row">
        <div>
          <label for="yearInput">å¹´ä»½</label>
          <input type="number" id="yearInput" value="2025" min="2000" max="2100" style="width:80px;">
        </div>
        <div>
          <label for="monthSelect">é¡¯ç¤ºæœˆä»½</label>
          <select id="monthSelect" onchange="buildMonthTable()">
            <option value="1">1 æœˆ</option>
            <option value="2">2 æœˆ</option>
            <option value="3">3 æœˆ</option>
            <option value="4">4 æœˆ</option>
            <option value="5">5 æœˆ</option>
            <option value="6">6 æœˆ</option>
            <option value="7">7 æœˆ</option>
            <option value="8">8 æœˆ</option>
            <option value="9">9 æœˆ</option>
            <option value="10">10 æœˆ</option>
            <option value="11">11 æœˆ</option>
            <option value="12">12 æœˆ</option>
          </select>
        </div>
        <div class="note">
          å¹³æ—¥æ­£å¸¸å·¥æ™‚ï¼š08:00â€“12:00ã€13:00â€“17:00ã€‚<br>
          ä¸Šç­é è¨­ 08:00ï¼›å¹³æ—¥ä¸‹ç­å¯é¸ 00:00ï½23:30ï¼Œå¦‚ä¸‹ç­æ™‚é–“æ—©æ–¼ / ç­‰æ–¼ä¸Šç­ï¼Œå¹³æ—¥æœƒè·³æ©˜æ¡†æé†’ä¸¦ä¸è¨ˆç®—ã€‚<br>
          åœ‹å®šå‡æ—¥ç›®å‰å…§å»º 2025 å¹´ï¼Œå¦‚åˆ‡æ›å…¶ä»–å¹´ä»½ï¼Œåœ‹å®šå‡æ—¥ä¸æœƒè‡ªå‹•æ¨™ç´…ã€‚
        </div>
      </div>
    </div>

    <div class="card">
      <h2>on call è¨ˆç®—</h2>
      <div class="flex-row">
        <div>
          <label>æœ¬çµç®—æœˆä»½ on call æ¬¡æ•¸</label>
          <input type="number" id="onCallCount" value="0" step="1" min="0">
        </div>
        <div class="note">
          on call è¨ˆç®—æ–¹å¼ï¼š1500 å…ƒ / æ¬¡ã€‚<br>
          æ­¤æ¬¡æ•¸æœƒç´å…¥ã€Œè–ªè³‡è©¦ç®—ï¼ˆçµç®—å€é–“ï¼‰ã€çš„ç¸½æ”¶å…¥ï¼ˆä¸ç®—åœ¨é¤è²»å…§ï¼‰ã€‚<br>
          è‹¥åˆ‡æ›ä¸åŒçµç®—æœˆä»½ï¼Œè«‹æ‰‹å‹•èª¿æ•´ç‚ºè©²æœˆä»½çš„å¯¦éš› on call æ¬¡æ•¸ã€‚
        </div>
      </div>
    </div>

    <div class="card scroll-card">
      <h2>æ¯æ—¥åŠ ç­ & å‡åˆ¥ç´€éŒ„ï¼ˆç›®å‰é¡¯ç¤ºæœˆä»½ï¼‰</h2>
      <table>
        <thead>
          <tr>
            <th>æ—¥æœŸ</th>
            <th>æ˜ŸæœŸ</th>
            <th>é¡å‹</th>
            <th>å‡åˆ¥</th>
            <th>ä¸Šç­</th>
            <th>ä¸‹ç­</th>
            <th>1.34 å°æ™‚</th>
            <th>1.67 å°æ™‚</th>
            <th>2.0 å°æ™‚</th>
            <th>2.67 å°æ™‚</th>
            <th>è£œä¼‘æ™‚æ•¸</th>
            <th>åŠ ç­è²»</th>
            <th>èª¤é¤æ•¸</th>
            <th>èª¤é¤è²»</th>
          </tr>
        </thead>
        <tbody id="daysBody"></tbody>
      </table>
      <div class="note">
        å¹³æ—¥ï¼š17:30â€“19:30 â†’ 1.34 å€ï¼›19:30â€“21:30 â†’ 1.67 å€ï¼›21:30 ä¹‹å¾Œæ”¹ç®—è£œä¼‘ï¼ˆÃ—2ï¼‰ï¼Œä¸å†ç®—åŠ ç­è²»ã€‚<br>
        å‡æ—¥ / åœ‹å®šå‡æ—¥ï¼š08:00â€“12:00ï¼‹13:00â€“17:00 â†’ 2 å€ï¼›17:30â€“21:30 â†’ 2.67 å€ï¼›12:00â€“13:00 ä¸åˆ—å…¥åŠ ç­ã€‚<br>
        å‡æ—¥ / åœ‹å®šå‡æ—¥é¤è²»ï¼šåªè¦æœ‰åŠ ç­ï¼ŒåŸºæœ¬ä¸€é¤ï¼›è‹¥åŠ ç­åˆ° 18:30 ä¹‹å¾Œï¼Œå‰‡å…©é¤ã€‚<br>
        å‡åˆ¥ï¼ˆç‰¹ä¼‘ / è£œä¿® / ç—…å‡ / äº‹å‡ï¼‰åªå½±éŸ¿å¹³æ—¥ 08â€“12ã€13â€“17 çš„çµ¦è–ªï¼Œä¸å½±éŸ¿åŠ ç­è²»ã€‚<br>
        å‘¨æœ«åŠåœ‹å®šå‡æ—¥è‹¥ä¸Šç­æ™‚é–“ â‰¥ ä¸‹ç­æ™‚é–“ï¼Œåªæ˜¯ä¸åˆ—å…¥è¨ˆç®—ï¼Œä¸æœƒé¡¯ç¤ºæ©˜æ¡†æé†’ã€‚
      </div>
    </div>

    <div id="sectionMonthlyOT" class="card">
      <h2>ä¸€ã€æœ¬æœˆåŠ ç­çµ±è¨ˆï¼ˆé¡¯ç¤ºæœˆä»½ï¼‰</h2>
      <div class="summary-grid">
        <div class="summary-item" id="itemMonthlyTotalHours">
          <strong>ç¸½åŠ ç­æ™‚æ•¸</strong>
          <span id="totalHours" class="value">0</span>
        </div>
        <div class="summary-item" id="itemMonthly133">
          <strong>1.34 ç¸½æ™‚æ•¸</strong>
          <span id="sum133" class="value">0</span>
        </div>
        <div class="summary-item" id="itemMonthly166">
          <strong>1.67 ç¸½æ™‚æ•¸</strong>
          <span id="sum166" class="value">0</span>
        </div>
        <div class="summary-item" id="itemMonthly200">
          <strong>2.0 ç¸½æ™‚æ•¸</strong>
          <span id="sum200" class="value">0</span>
        </div>
        <div class="summary-item" id="itemMonthly267">
          <strong>2.67 ç¸½æ™‚æ•¸</strong>
          <span id="sum267" class="value">0</span>
        </div>
        <div class="summary-item" id="itemMonthlyCompHours">
          <strong>ç¸½è£œä¼‘æ™‚æ•¸</strong>
          <span id="sumComp" class="value">0</span>
        </div>
        <div class="summary-item" id="itemMonthlyCompCash">
          <strong>è£œä¼‘æŠ˜ç¾é‡‘é¡ï¼ˆæœ¬æœˆï¼‰</strong>
          <span id="compCashMonthly" class="value">0</span>
        </div>
        <div class="summary-item" id="itemMonthlyOTPay">
          <strong>ç¸½åŠ ç­è²»ï¼ˆæœ¬æœˆï¼‰</strong>
          <span id="sumOTPayMonthly" class="value">0</span>
        </div>
      </div>
    </div>

    <div id="sectionMonthlyMeal" class="card">
      <h2>äºŒã€æœ¬æœˆèª¤é¤çµ±è¨ˆï¼ˆé¡¯ç¤ºæœˆä»½ï¼‰</h2>
      <div class="summary-grid">
        <div class="summary-item" id="itemMonthlyMealCount">
          <strong>ç¸½èª¤é¤æ•¸</strong>
          <span id="sumMealsMonthly" class="value">0</span>
        </div>
        <div class="summary-item" id="itemMonthlyMealFee">
          <strong>ç¸½èª¤é¤è²»</strong>
          <span id="sumMealFeeMonthly" class="value">0</span>
        </div>
      </div>
    </div>

    <div id="sectionSalary" class="card">
      <h2>ä¸‰ã€è–ªè³‡è©¦ç®—ï¼ˆçµç®—å€é–“ï¼‰</h2>
      <div class="note" id="payPeriodLabel2"></div>
      <div class="summary-grid">
        <div class="summary-item" id="itemSalaryFixIn">
          <strong>å›ºå®šæ”¶å…¥å°è¨ˆ</strong>
          <span id="fixedIncomeMonthly" class="value">0</span>
        </div>
        <div class="summary-item" id="itemSalaryFixOut">
          <strong>å›ºå®šæ”¯å‡ºå°è¨ˆ</strong>
          <span id="fixedOutgoMonthly" class="value">0</span>
        </div>
        <div class="summary-item" id="itemSalaryTotalHours">
          <strong>çµç®—å€é–“ç¸½åŠ ç­æ™‚æ•¸</strong>
          <span id="ppTotalHours" class="value">0</span>
        </div>
        <div class="summary-item" id="itemSalary133">
          <strong>çµç®—å€é–“ 1.34 æ™‚æ•¸</strong>
          <span id="ppH133" class="value">0</span>
        </div>
        <div class="summary-item" id="itemSalary166">
          <strong>çµç®—å€é–“ 1.67 æ™‚æ•¸</strong>
          <span id="ppH166" class="value">0</span>
        </div>
        <div class="summary-item" id="itemSalary200">
          <strong>çµç®—å€é–“ 2.0 æ™‚æ•¸</strong>
          <span id="ppH200" class="value">0</span>
        </div>
        <div class="summary-item" id="itemSalary267">
          <strong>çµç®—å€é–“ 2.67 æ™‚æ•¸</strong>
          <span id="ppH267" class="value">0</span>
        </div>
        <div class="summary-item" id="itemSalaryOTPay">
          <strong>çµç®—å€é–“åŠ ç­è²»</strong>
          <span id="ppSumOTPay" class="value">0</span>
        </div>
        <div class="summary-item" id="itemSalaryCompCash">
          <strong>çµç®—å€é–“è£œä¼‘æŠ˜ç¾</strong>
          <span id="ppCompCash" class="value">0</span>
        </div>
        <div class="summary-item" id="itemSalaryOncallCount">
          <strong>on call æ¬¡æ•¸ï¼ˆçµç®—å€é–“ï¼‰</strong>
          <span id="onCallCountDisplay" class="value">0</span>
        </div>
        <div class="summary-item" id="itemSalaryOncallAmount">
          <strong>on call é‡‘é¡</strong>
          <span id="onCallAmountDisplay" class="value">0</span>
        </div>
        <div class="summary-item" id="itemSalarySickH">
          <strong>ç—…å‡æ™‚æ•¸ï¼ˆçµç®—å€é–“ï¼‰</strong>
          <span id="sickHours" class="value">0</span>
        </div>
        <div class="summary-item" id="itemSalarySickDed">
          <strong>ç—…å‡æ‰£æ¬¾ï¼ˆçµç®—å€é–“ï¼‰</strong>
          <span id="sickDeduction" class="value negative">0</span>
        </div>
        <div class="summary-item" id="itemSalaryPersonalH">
          <strong>äº‹å‡æ™‚æ•¸ï¼ˆçµç®—å€é–“ï¼‰</strong>
          <span id="personalHours" class="value">0</span>
        </div>
        <div class="summary-item" id="itemSalaryPersonalDed">
          <strong>äº‹å‡æ‰£æ¬¾ï¼ˆçµç®—å€é–“ï¼‰</strong>
          <span id="personalDeduction" class="value negative">0</span>
        </div>
        <div class="summary-item" id="itemSalaryTotalIncome">
          <strong>ç¸½æ”¶å…¥ï¼ˆå«è£œä¼‘æŠ˜ç¾ï¼‹on callï¼Œä¸å«é¤è²»ï¼‰</strong>
          <span id="totalIncome" class="value">0</span>
        </div>
      </div>
    </div>
  </div>

  <script>
    // =================================================================
    // Gist é›²ç«¯åŒæ­¥è¨­å®š (å·²ç§»é™¤æœ¬åœ°ç«¯å„²å­˜)
    // =================================================================
    const GIST_ID = "3cc2bcacedfb21435f74ce15ef37b951";
    // è­¦å‘Šï¼šå°‡ PAT å¯«åœ¨å‰ç«¯ç¨‹å¼ç¢¼ä¸­æ¥µä¸å®‰å…¨ï¼
    const PAT = "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"; 
    const GIST_FILENAME = "overtime_data.json";

    let currentYear = 2025;
    let dayData = {}; // YYYY-MM-DD -> { start, end, leaveType }

    // Gist ç›¸é—œ API å‡½å¼
    async function fetchGistContent() {
        const url = `https://api.github.com/gists/${GIST_ID}`;
        const headers = {
            'Authorization': `token ${PAT}`,
            'Accept': 'application/vnd.github.v3+json'
        };

        try {
            const response = await fetch(url, { headers });
            if (!response.ok) {
                // 404 Not Found is expected if Gist ID is wrong or PAT has no read access.
                if (response.status === 404) {
                    console.warn(`Gist ID ${GIST_ID} æœªæ‰¾åˆ°æˆ–æ¬Šé™ä¸è¶³ã€‚å°‡ä½¿ç”¨é è¨­è¨­å®šã€‚`);
                    return null;
                }
                throw new Error(`GitHub API Error: ${response.status} ${response.statusText}`);
            }
            const gist = await response.json();
            
            if (gist.files && gist.files[GIST_FILENAME]) {
                const content = gist.files[GIST_FILENAME].content;
                console.log("State successfully loaded from Gist.");
                return content; // This is the JSON string
            } else {
                console.warn(`Gist æª”æ¡ˆ '${GIST_FILENAME}' åœ¨ Gist ID: ${GIST_ID} ä¸­æœªæ‰¾åˆ°ã€‚å°‡ä½¿ç”¨é è¨­è¨­å®šã€‚`);
                return null;
            }
        } catch (error) {
            console.error("è¼‰å…¥é›²ç«¯è³‡æ–™å¤±æ•—:", error);
            alert(`è¼‰å…¥é›²ç«¯è³‡æ–™å¤±æ•—ã€‚è«‹æª¢æŸ¥ GIST IDã€PAT æˆ–ç¶²è·¯é€£ç·šã€‚\néŒ¯èª¤: ${error.message}`);
            return null;
        }
    }

    async function updateGistContent(jsonString) {
        const url = `https://api.github.com/gists/${GIST_ID}`;
        const headers = {
            'Authorization': `token ${PAT}`,
            'Accept': 'application/vnd.github.v3+json',
            'Content-Type': 'application/json'
        };
        
        const payload = {
            description: "Auto-saved overtime data",
            files: {
                [GIST_FILENAME]: {
                    content: jsonString
                }
            }
        };

        try {
            const response = await fetch(url, { 
                method: 'PATCH', 
                headers: headers, 
                body: JSON.stringify(payload) 
            });

            if (!response.ok) {
                const errorText = await response.text();
                throw new Error(`GitHub API Error: ${response.status} ${response.statusText}. Response: ${errorText.substring(0, 100)}...`);
            }
            console.log("State successfully saved to Gist.");
            return true;

        } catch (error) {
            console.error("å„²å­˜é›²ç«¯è³‡æ–™å¤±æ•—:", error);
            // ç”±æ–¼å„²å­˜æ“ä½œéå¸¸é »ç¹ï¼Œåƒ…åœ¨æ§åˆ¶å°é¡¯ç¤ºéŒ¯èª¤ï¼Œé¿å…éåº¦æ‰“æ“¾ä½¿ç”¨è€…
            // alert(`å„²å­˜é›²ç«¯è³‡æ–™å¤±æ•—ã€‚è«‹æª¢æŸ¥ PAT æˆ–ç¶²è·¯é€£ç·šã€‚\néŒ¯èª¤: ${error.message}`);
            return false;
        }
    }
    // =================================================================
    // ç‹€æ…‹ç®¡ç†å‡½å¼
    // =================================================================
    
    // å–å¾—ç•¶å‰æ‡‰ç”¨ç¨‹å¼ç‹€æ…‹ç‰©ä»¶
    function getCurrentStateObject() {
        const state = {
            currentYear,
            dayData,
            salary: {
                baseSalary: document.getElementById("baseSalary").value,
                dutyAllowance: document.getElementById("dutyAllowance").value,
                trafficAllowance: document.getElementById("trafficAllowance").value,
                maintenanceAllowance: document.getElementById("maintenanceAllowance").value,
                stockCompanyIncome: document.getElementById("stockCompanyIncome").value,
                laborInsurance: document.getElementById("laborInsurance").value,
                healthInsurance: document.getElementById("healthInsurance").value,
                stockCompanyDeduct: document.getElementById("stockCompanyDeduct").value,
                stockSelfDeduct: document.getElementById("stockSelfDeduct").value
            },
            cutoffs: {
                1: document.getElementById("cutoff1").value, 2: document.getElementById("cutoff2").value, 3: document.getElementById("cutoff3").value, 4: document.getElementById("cutoff4").value,
                5: document.getElementById("cutoff5").value, 6: document.getElementById("cutoff6").value, 7: document.getElementById("cutoff7").value, 8: document.getElementById("cutoff8").value,
                9: document.getElementById("cutoff9").value, 10: document.getElementById("cutoff10").value, 11: document.getElementById("cutoff11").value, 12: document.getElementById("cutoff12").value
            },
            visibility: {
                showMonthlyOT: document.getElementById("chkShowMonthlyOT").checked,
                showMonthlyMeal: document.getElementById("chkShowMonthlyMeal").checked,
                showSalary: document.getElementById("chkShowSalary").checked,
                fields: {}
            },
            onCallCount: document.getElementById("onCallCount").value,
            payMonth: document.getElementById("payMonthSelect").value
        };

        const fieldCheckboxIds = [
            "fieldMonthlyTotalHours", "fieldMonthly133", "fieldMonthly166", "fieldMonthly200", "fieldMonthly267", "fieldMonthlyCompHours", "fieldMonthlyCompCash", "fieldMonthlyOTPay",
            "fieldMonthlyMealCount", "fieldMonthlyMealFee",
            "fieldSalaryFixIn", "fieldSalaryFixOut", "fieldSalaryTotalHours", "fieldSalary133", "fieldSalary166", "fieldSalary200", "fieldSalary267",
            "fieldSalaryOTPay", "fieldSalaryCompCash", "fieldSalaryOncallCount", "fieldSalaryOncallAmount", "fieldSalarySickH", "fieldSalarySickDed", "fieldSalaryPersonalH", "fieldSalaryPersonalDed", "fieldSalaryTotalIncome"
        ];
        fieldCheckboxIds.forEach(id => {
            const el = document.getElementById(id);
            if (el) state.visibility.fields[id] = el.checked;
        });

        return state;
    }

    // å„²å­˜ç‹€æ…‹è‡³ Gist
    async function saveState() {
        const state = getCurrentStateObject();
        const json = JSON.stringify(state, null, 2);
        await updateGistContent(json);
    }

    // å¾ Gist è¼‰å…¥ç‹€æ…‹
    async function loadState() {
        const stateJson = await fetchGistContent();
        if (!stateJson) return; // è¼‰å…¥å¤±æ•—æˆ–æª”æ¡ˆä¸å­˜åœ¨ï¼Œä½¿ç”¨é è¨­å€¼

        try {
            const state = JSON.parse(stateJson);

            // æ‡‰ç”¨ç‹€æ…‹
            if (state.currentYear) currentYear = Number(state.currentYear);
            document.getElementById("yearInput").value = currentYear;
            
            if (state.dayData) dayData = state.dayData;

            if (state.salary) {
                document.getElementById("baseSalary").value = state.salary.baseSalary ?? "45500";
                document.getElementById("dutyAllowance").value = state.salary.dutyAllowance ?? "0";
                document.getElementById("trafficAllowance").value = state.salary.trafficAllowance ?? "0";
                document.getElementById("maintenanceAllowance").value = state.salary.maintenanceAllowance ?? "0";
                document.getElementById("stockCompanyIncome").value = state.salary.stockCompanyIncome ?? "0";
                document.getElementById("laborInsurance").value = state.salary.laborInsurance ?? "0";
                document.getElementById("healthInsurance").value = state.salary.healthInsurance ?? "0";
                document.getElementById("stockCompanyDeduct").value = state.salary.stockCompanyDeduct ?? "0";
                document.getElementById("stockSelfDeduct").value = state.salary.stockSelfDeduct ?? "0";
            }
            if (state.cutoffs) {
                for (let m = 1; m <= 12; m++) {
                    const v = state.cutoffs[m] ?? document.getElementById("cutoff" + m).value;
                    document.getElementById("cutoff" + m).value = v;
                }
            }
            if (state.visibility) {
                document.getElementById("chkShowMonthlyOT").checked = !!state.visibility.showMonthlyOT;
                document.getElementById("chkShowMonthlyMeal").checked = !!state.visibility.showMonthlyMeal;
                document.getElementById("chkShowSalary").checked = !!state.visibility.showSalary;
                const f = state.visibility.fields || {};
                function setField(id) {
                    const el = document.getElementById(id);
                    if (el && f.hasOwnProperty(id)) {
                        el.checked = !!f[id];
                    }
                }
                [ 
                    "fieldMonthlyTotalHours", "fieldMonthly133", "fieldMonthly166",
                    "fieldMonthly200", "fieldMonthly267", "fieldMonthlyCompHours",
                    "fieldMonthlyCompCash", "fieldMonthlyOTPay",
                    "fieldMonthlyMealCount", "fieldMonthlyMealFee",
                    "fieldSalaryFixIn", "fieldSalaryFixOut", "fieldSalaryTotalHours",
                    "fieldSalary133", "fieldSalary166", "fieldSalary200", "fieldSalary267",
                    "fieldSalaryOTPay", "fieldSalaryCompCash",
                    "fieldSalaryOncallCount", "fieldSalaryOncallAmount",
                    "fieldSalarySickH", "fieldSalarySickDed",
                    "fieldSalaryPersonalH", "fieldSalaryPersonalDed",
                    "fieldSalaryTotalIncome"
                ].forEach(setField);
            }
            if (state.onCallCount) {
                document.getElementById("onCallCount").value = state.onCallCount;
            }
            if (state.payMonth) {
                document.getElementById("payMonthSelect").value = state.payMonth;
            }

        } catch (error) {
            console.error("è§£æ Gist JSON éŒ¯èª¤:", error);
            alert("é›²ç«¯è³‡æ–™æ ¼å¼éŒ¯èª¤ï¼Œå·²é‡è¨­ç‚ºé è¨­è¨­å®šã€‚");
        }
    }
    
    // =================================================================
    // è¼”åŠ©å‡½å¼ (ä¿ç•™åŸå§‹åŠŸèƒ½)
    // =================================================================
    const taiwanHolidays2025 = new Set([
      "2025-01-01",
      "2025-01-27","2025-01-28","2025-01-29","2025-01-30","2025-01-31",
      "2025-02-28",
      "2025-04-03","2025-04-04",
      "2025-05-30","2025-05-31",
      "2025-09-29",
      "2025-10-06","2025-10-10",
      "2025-10-24","2025-10-25",
      "2025-12-25"
    ]);

    const memeList = [
      // work
      { title: "æ—©ä¸Šè·Ÿè‡ªå·±èªªï¼šä»Šå¤©ä¸€å®šæº–æ™‚ä¸‹ç­ã€‚", subtitle: "æ™šä¸Š 21:30 çš„ä½ ï¼šå…ˆæŠŠåŠ ç­æ™‚æ•¸ key å®Œå†èªªã€‚", tag: "work" },
      { title: "ä¸»ç®¡èªªï¼šé€™æ¡ˆå­ä¸æœƒåŠ ç­å•¦ï½", subtitle: "çµæœä½ åœ¨çµç®—æ—¥çœ‹è‘— 1.34ã€1.67 æ¬„ä½é»˜é»˜æµæ·šã€‚", tag: "work" },
      { title: "æœ‰äººå•ï¼šä½ ç‚ºä»€éº¼é‚£éº¼æœƒç®—åŠ ç­è²»ï¼Ÿ", subtitle: "æˆ‘ï¼šå› ç‚ºä¸æœƒç®—å°±æœƒè¢«å…¬å¸ç®—ã€‚", tag: "work" },
      { title: "æ‰€è¬‚æœˆå…‰æ—ï¼š", subtitle: "ä¸æ˜¯ä¸æœƒå­˜éŒ¢ï¼Œæ˜¯åŠ ç­è²»é‚„æ²’è£œé½Šæœ¬è–ªçš„æ´ã€‚", tag: "work" },
      { title: "æœ€å®³æ€•è½åˆ°çš„ä¸€å¥è©±ï¼š", subtitle: "ã€Œé€™å€‹å°±å…ˆåšï¼Œä¹‹å¾Œå†è£œ OTã€‚ã€", tag: "work" },
      { title: "çœ‹åˆ° 21:30 ä¹‹å¾Œéƒ½æ˜¯è£œä¼‘ï¼š", subtitle: "å¿ƒæƒ…è¤‡é›œï¼šæƒ³ä¼‘å‡åˆæƒ³è¦ç¾é‡‘ã€‚", tag: "work" },
      { title: "åŠ ç­åˆ°æ‡·ç–‘äººç”Ÿï¼š", subtitle: "ä½†æ‰“é–‹è©¦ç®—è¡¨çœ‹è¦‹ OT é‡‘é¡ï¼Œåˆè¦ºå¾—é‚„å¯ä»¥å†æ’ä¸€ä¸‹ã€‚", tag: "work" },
      { title: "åŒäº‹å•ï¼šç‚ºä»€éº¼ä½  Excel é‚£éº¼å¼·ï¼Ÿ", subtitle: "æˆ‘ï¼šå› ç‚ºæˆ‘è¦ç¢ºå®šæ¯ä¸€åˆ†é˜éƒ½æœ‰ç®—éŒ¢ã€‚", tag: "work" },
      { title: "åˆ¥äººèªªã€Œä¸‹ç­åƒé£¯å—ï¼Ÿã€", subtitle: "æˆ‘å…ˆçœ‹ä»Šå¤©æœ‰æ²’æœ‰è¶…é 18:30ï¼Œèª¤é¤è²»è¦ç®—é€²å»ã€‚", tag: "work" },
      { title: "æœ€æ€•è½åˆ°ï¼š", subtitle: "ã€Œé€™å€‹ç¦®æ‹œå…­å¯èƒ½è¦ä¾†ä¸€ä¸‹å–”ã€‚ã€", tag: "work" },
      { title: "åˆ¥äººé€±æœ«è¿½åŠ‡ï¼š", subtitle: "æˆ‘é€±æœ«è¿½å·¥å–®ï¼Œé †ä¾¿è¿½æˆ‘çš„åŠ ç­è²»ã€‚", tag: "work" },
      { title: "äººç”Ÿä¸‰å¤§å¹»è¦ºä¹‹ä¸€ï¼š", subtitle: "é€™æ¬¡æ‡‰è©²ä¸ç”¨åŠ ç­äº†ã€‚", tag: "work" },
      { title: "æœ‰äººèªªï¼šéŒ¢ä¸æ˜¯è¬èƒ½ã€‚", subtitle: "æˆ‘èªªï¼šä½†ç®—å®Œ OT çš„é‚£ä¸€åˆ»ï¼ŒçœŸçš„å¾ˆæœ‰å®‰å…¨æ„Ÿã€‚", tag: "work" },
      { title: "æœ€æµªæ¼«çš„å ´åˆï¼š", subtitle: "ä¸æ˜¯æµ·é‚Šçœ‹æ—¥å‡ºï¼Œæ˜¯ä¸€èµ·åœ¨è¾¦å…¬å®¤çœ‹çµç®—æ—¥ã€‚", tag: "work" },
      { title: "å¤§å®¶éƒ½èªªè¦ work-life balanceã€‚", subtitle: "æˆ‘ç›®å‰æ˜¯ work-OT balanceï¼Œå…ˆæŠŠ OT balance èµ·ä¾†ã€‚", tag: "work" },
      // life
      { title: "æ¸›è‚¥è¨ˆç•« Day 1ï¼š", subtitle: "æ™šé¤åªåƒä¸€é»é»â€¦ç„¶å¾Œå†åŠ ä¸€ä»½å®µå¤œã€‚", tag: "life" },
      { title: "é¬§é˜è¨­å…­å€‹æ™‚é–“ï¼š", subtitle: "èµ·åºŠåªç›¸ä¿¡æœ€å¾Œé‚£ä¸€å€‹ã€‚", tag: "life" },
      { title: "æ˜æ˜å¾ˆç´¯äº†é‚„ä¸ç¡ï¼š", subtitle: "å› ç‚ºè¦ºå¾—ä¸€ç¡è‘—ï¼Œä»Šå¤©å°±æ­£å¼çµæŸäº†ã€‚", tag: "life" },
      { title: "æ‰‹æ©Ÿé›»é‡ 1% æœƒç·Šå¼µï¼Œ", subtitle: "å­˜æ¬¾ 1% è¦ºå¾—é‚„å¥½ï¼Œåæ­£ç™¼è–ªæ—¥ç¸½æœƒä¾†ã€‚", tag: "life" },
      { title: "èªªè¦æ—©èµ·é‹å‹•çš„æ™šä¸Šï¼š", subtitle: "æœ€å®¹æ˜“å…ˆå¤–é€ä¸€å †é«˜ç†±é‡çŠ’è³è‡ªå·±ã€‚", tag: "life" },
      { title: "æœ€å¸¸æŒ‰çš„ä¸‰å€‹éµï¼š", subtitle: "æˆªåœ–ã€éœéŸ³ã€å»¶å¾Œé¬§é˜ã€‚", tag: "life" },
      { title: "å‡æ—¥è¡Œç¨‹è¦åŠƒï¼š", subtitle: "æ—©ä¸Šï¼šã€Œç­‰ä¸€ä¸‹å°±å‡ºé–€ã€â†’ æ™šä¸Šï¼šã€Œç®—äº†ï¼Œä¸‹æ¬¡å†èªªã€ã€‚", tag: "life" },
      { title: "é–‹å§‹å­˜éŒ¢ä¹‹å¾Œæ‰ç™¼ç¾ï¼š", subtitle: "ä¸æ˜¯æˆ‘ä¸æœƒç†è²¡ï¼Œæ˜¯ç”Ÿæ´»çœŸçš„å¾ˆæœƒèŠ±éŒ¢ã€‚", tag: "life" },
      { title: "æ‰“é–‹éŠ€è¡Œ App çš„ç¬é–“ï¼š", subtitle: "åƒåœ¨æ‹†é©šå–œåŒ…ï¼Œåªæ˜¯å¤§éƒ¨åˆ†æ˜¯é©šåš‡åŒ…ã€‚", tag: "life" },
      { title: "æ‰€è¬‚é•·å¤§ï¼š", subtitle: "çœ‹åˆ°æ‰“æŠ˜ä¸æ˜¯å¾ˆé–‹å¿ƒï¼Œæ˜¯åœ¨æƒ³ï¼šé€™å€‹æˆ‘çœŸçš„éœ€è¦å—ï¼Ÿ", tag: "life" },
      { title: "æ‰“æƒæˆ¿é–“æœ€å¯æ€•çš„ä¸€åˆ»ï¼š", subtitle: "ä¸æ˜¯ç°å¡µï¼Œè€Œæ˜¯æ‰¾åˆ°ä»¥å‰äº‚è²·çš„æ±è¥¿ã€‚", tag: "life" },
      { title: "æœ‹å‹ç´„å‡ºå»ï¼š", subtitle: "ç­”æ‡‰ä¹‹å‰å…ˆçœ‹ä¸€ä¸‹æˆ¶é ­é¤˜é¡è·Ÿæ˜å¤©è¡Œç¨‹ã€‚", tag: "life" },
      { title: "æ‰€è¬‚ç™‚ç™’ï¼š", subtitle: "ä¸æ˜¯ä»€éº¼é«˜ç´šè¡Œç¨‹ï¼Œæ˜¯èººåœ¨åºŠä¸Šæ»‘æ‰‹æ©Ÿæ»‘åˆ°ç¡è‘—ã€‚", tag: "life" },
      // mix
      { title: "ç™½å¤©ä¸Šç­ã€æ™šä¸Šæ»‘æ‰‹æ©Ÿï¼Œ", subtitle: "å‡æ—¥åœ¨æƒ³ï¼šåˆ°åº•ä»€éº¼æ™‚å€™æ‰æ˜¯çœŸçš„åœ¨ä¼‘æ¯ï¼Ÿ", tag: "mix" },
      { title: "æœ€ç—›è‹¦çš„ä¸æ˜¯åŠ ç­ï¼Œ", subtitle: "æ˜¯åŠ ç­å®Œéš”å¤©é‚„è¦æ—©èµ·ä¸Šç­ã€‚", tag: "mix" }
    ];

    let allTimes = [];
    let weekdayEndTimes = [];
    (function generateTimeOptions() {
      for (let h = 0; h < 24; h++) {
        for (let m = 0; m < 60; m += 30) {
          const hh = String(h).padStart(2, "0");
          const mm = String(m).padStart(2, "0");
          const t = `${hh}:${mm}`;
          allTimes.push(t);
          if (h * 60 + m >= 17 * 60 || h * 60 + m === 0) { // 17:00 ~ 23:30, 00:00
            weekdayEndTimes.push(t);
          }
        }
      }
    })();

    function isNationalHoliday(dateObj) {
      const y = dateObj.getFullYear();
      const m = String(dateObj.getMonth() + 1).padStart(2, "0");
      const d = String(dateObj.getDate()).padStart(2, "0");
      if (y === 2025) {
        return taiwanHolidays2025.has(`${y}-${m}-${d}`);
      }
      return false;
    }

    function getHourlyBase() {
      const base = Number(document.getElementById("baseSalary").value) || 0;
      const duty = Number(document.getElementById("dutyAllowance").value) || 0;
      const traffic = Number(document.getElementById("trafficAllowance").value) || 0;
      // ä¾å‹åŸºæ³•ï¼Œæ™‚è–ªè¨ˆç®—åŸºç¤ç‚º (æœˆè–ªç¸½é¡ Ã· 30 æ—¥ Ã· 8 å°æ™‚)
      // å¯¦å‹™ä¸Šå¯èƒ½ç”¨ (æœ¬è–ª + è·å‹™åŠ çµ¦ + äº¤é€šæ´¥è²¼) / 240
      const hourly = Math.round((base + duty + traffic) / 240);
      return hourly;
    }

    function recalcSalaryStructureSummary() {
      const base = Number(document.getElementById("baseSalary").value) || 0;
      const duty = Number(document.getElementById("dutyAllowance").value) || 0;
      const traffic = Number(document.getElementById("trafficAllowance").value) || 0;
      const maint = Number(document.getElementById("maintenanceAllowance").value) || 0;
      const stockIn = Number(document.getElementById("stockCompanyIncome").value) || 0;
      
      const labor = Number(document.getElementById("laborInsurance").value) || 0;
      const health = Number(document.getElementById("healthInsurance").value) || 0;
      const stockOut = Number(document.getElementById("stockCompanyDeduct").value) || 0;
      const stockSelf = Number(document.getElementById("stockSelfDeduct").value) || 0;

      const hourly = getHourlyBase();
      const fixedIncome = base + duty + traffic + maint + stockIn;
      const fixedOutgo = labor + health + stockOut + stockSelf;

      document.getElementById("hourlyBaseDisplay").textContent = fmtMoney(hourly);
      document.getElementById("fixedIncomeDisplay").textContent = fmtMoney(fixedIncome);
      document.getElementById("fixedOutgoDisplay").textContent = fmtMoney(fixedOutgo);

      // åŒæ­¥åˆ°è–ªè³‡è©¦ç®—å€å¡Š
      document.getElementById("fixedIncomeMonthly").textContent = fmtMoney(fixedIncome);
      document.getElementById("fixedOutgoMonthly").textContent = fmtMoney(fixedOutgo);
    }

    function recalcAll() {
      recalcSalaryStructureSummary();
      buildMonthTable();
      updatePayPeriodSummary();
      saveState();
    }

    function createSelect(options, cssClass) {
      const sel = document.createElement("select");
      sel.className = cssClass;
      for (const t of options) {
        const opt = document.createElement("option");
        opt.value = t;
        opt.textContent = t;
        sel.appendChild(opt);
      }
      return sel;
    }

    function createLeaveSelect() {
      const sel = document.createElement("select");
      sel.className = "leave-type";
      const options = [
        { value: "normal", text: "æ­£å¸¸ä¸Šç­" },
        { value: "annual", text: "ç‰¹ä¼‘" },
        { value: "comp", text: "è£œä¼‘" },
        { value: "sick", text: "ç—…å‡" },
        { value: "personal", text: "äº‹å‡" }
      ];
      for (const o of options) {
        const opt = document.createElement("option");
        opt.value = o.value;
        opt.textContent = o.text;
        sel.appendChild(opt);
      }
      return sel;
    }

    function parseTimeToMinutes(str) {
      if (!str) return null;
      const [hh, mm] = str.split(":");
      const h = parseInt(hh, 10);
      const m = parseInt(mm, 10);
      if (isNaN(h) || isNaN(m)) return null;
      return h * 60 + m;
    }

    function fmtNumber(n, digits=2) {
      return Number.isFinite(n) ? n.toFixed(digits) : "0";
    }

    function fmtMoney(n) {
      return Number.isFinite(n) ? Math.round(n).toLocaleString() : "0";
    }

    function computeDayStats(dateObj, startStr, endStr, hourly, leaveType) {
      const result = { 
        h133: 0, h166: 0, h200: 0, h267: 0, comp: 0, 
        otPay: 0, meals: 0, mealFee: 0, compCash: 0, 
        sickLeaveHours: 0, personalLeaveHours: 0, 
        sickDeduction: 0, personalDeduction: 0 
      };

      const startMin = parseTimeToMinutes(startStr);
      const endMin = parseTimeToMinutes(endStr);
      
      // ç„¡æ•ˆæ™‚é–“æˆ–æ™‚è–ªç‚ºé›¶ï¼Œç›´æ¥è¿”å›
      if (startMin === null || endMin === null || hourly <= 0) {
         return result;
      }
      
      let e = endMin;
      let s = startMin;

      // è™•ç†è·¨æ—¥å•é¡Œï¼šå¦‚æœä¸‹ç­æ™‚é–“æ—©æ–¼ä¸Šç­æ™‚é–“ (ä¸”ä¸æ˜¯ 00:00~07:30 å€é–“)ï¼Œè¦–ç‚ºéš”æ—¥å‡Œæ™¨
      // é€™è£¡å‡è¨­éš”æ—¥ä¸‹ç­æœ€æ™šåˆ° 07:30ï¼Œä»¥ç°¡åŒ–è¨ˆç®—ï¼Œå¯¦éš›å¯èƒ½éœ€è¦æ›´è¤‡é›œçš„é‚è¼¯
      if (e <= s && (e > 7*60 + 30)) {
        // e = e + 24 * 60; // æš«ä¸è™•ç†è·¨æ—¥ï¼Œå¦‚æœ end < start ä¸”éæ¸…æ™¨ï¼Œè¦–ç‚ºç„¡æ•ˆæˆ–éš”æ—¥
      }
      if (e <= s) {
        // å¹³æ—¥ç„¡æ•ˆï¼šä¸‹ç­æ™‚é–“æ—©æ–¼æˆ–ç­‰æ–¼ä¸Šç­æ™‚é–“
      }

      const weekday = dateObj.getDay();
      const isWeekend = (weekday === 0 || weekday === 6);
      const holiday = isNationalHoliday(dateObj);
      const isHolidayType = isWeekend || holiday;

      if (!isHolidayType) {
        // --- å¹³æ—¥åŠ ç­è¨ˆç®— (1.34/1.67/è£œä¼‘) ---
        // 17:30-19:30 (1.34)
        const win133Start = 17*60 + 30;
        const win133End = 19*60 + 30;
        // 19:30-21:30 (1.67)
        const win166Start = 19*60 + 30;
        const win166End = 21*60 + 30;
        // 21:30 ä¹‹å¾Œ (è£œä¼‘/2å€å·¥æ™‚)
        const winCompStart = 21*60 + 30;
        
        let a1 = Math.max(s, win133Start);
        let b1 = Math.min(e, win133End);
        if (b1 > a1) result.h133 = (b1 - a1) / 60;

        let a2 = Math.max(s, win166Start);
        let b2 = Math.min(e, win166End);
        if (b2 > a2) result.h166 = (b2 - a2) / 60;

        let a3 = Math.max(s, winCompStart);
        let b3 = e;
        if (b3 > a3) result.comp = (b3 - a3) / 60;
        
        // å¹³æ—¥é¤è²»ï¼š
        // ä¸‹ç­æ™‚é–“ > 18:30 â†’ 1é¤
        if (e > 18*60 + 30) {
            result.meals = 1;
        } else {
            result.meals = 0;
        }

        // å¹³æ—¥è«‹å‡/æ‰£æ¬¾è¨ˆç®— (08:00â€“12:00, 13:00â€“17:00)
        const baseHours = 8;
        const ws1 = 8*60, we1 = 12*60;
        const ws2 = 13*60, we2 = 17*60;

        // è¨ˆç®—æ­£å¸¸å·¥æ™‚ (08-12, 13-17) å…§çš„æ‰“å¡æ™‚æ•¸
        const w1 = Math.max(0, Math.min(e, we1) - Math.max(s, ws1));
        const w2 = Math.max(0, Math.min(e, we2) - Math.max(s, ws2));
        const workHours = (w1 + w2) / 60;
        
        let leaveHours = baseHours - workHours;
        if (leaveHours < 0) leaveHours = 0; // ä¸æœƒå‡ºç¾è² å€¼

        if (leaveType === "sick") {
            result.sickLeaveHours = leaveHours;
            result.sickDeduction = leaveHours * hourly * 0.5; // ç—…å‡åŠè–ª
        } else if (leaveType === "personal") {
            result.personalLeaveHours = leaveHours;
            result.personalDeduction = leaveHours * hourly; // äº‹å‡ä¸çµ¦è–ª
        }
        // annual / comp / normal éƒ½è¦–ç‚ºæ­£å¸¸çµ¦è–ªï¼Œä¸æ‰£æ¬¾

      } else {
        // --- å‡æ—¥/åœ‹å®šå‡æ—¥åŠ ç­è¨ˆç®— (2.0/2.67) ---
        // 08:00â€“12:00, 13:00â€“17:00 (2.0 å€)
        const win200Start1 = 8*60; const win200End1 = 12*60;
        const win200Start2 = 13*60; const win200End2 = 17*60;
        // 17:30â€“21:30 (2.67 å€)
        const win267Start = 17*60 + 30; 
        const win267End = 21*60 + 30;

        // 2.0 å€ (å‰ 8 å°æ™‚)
        let a1 = Math.max(s, win200Start1);
        let b1 = Math.min(e, win200End1);
        if (b1 > a1) result.h200 += (b1 - a1) / 60;
        
        let a2 = Math.max(s, win200Start2);
        let b2 = Math.min(e, win200End2);
        if (b2 > a2) result.h200 += (b2 - a2) / 60;

        // 2.67 å€ (è¶…æ™‚ 4 å°æ™‚)
        let a3 = Math.max(s, win267Start);
        let b3 = Math.min(e, win267End);
        if (b3 > a3) result.h267 = (b3 - a3) / 60;
        
        const totalHolidayHours = result.h200 + result.h267;

        // å‡æ—¥é¤è²»ï¼š
        // åªè¦æœ‰åŠ ç­ï¼ˆtotalHolidayHours > 0ï¼‰â†’ åŸºæœ¬ä¸€é¤ï¼ˆåˆé¤ 12:30 æˆ–æ™šé¤ 18:30ï¼‰
        // è‹¥ä¸‹ç­æ™‚é–“ > 18:30 â†’ å…©é¤ã€‚
        if (totalHolidayHours > 0) {
            result.meals = 1;
            // åˆ¤æ–·æ˜¯å¦æ¶µè“‹å…©å€‹ç”¨é¤æ™‚é–“ï¼ˆåˆé¤ 12:30ï¼Œæ™šé¤ 18:30ï¼‰
            if (e > 18*60 + 30) {
                result.meals = 2;
            } else if (e > 12*60 + 30) {
                 result.meals = 1; // æœ‰é 12:30 ä¸”æ²’é 18:30ï¼Œç®— 1 é¤
            } else {
                 result.meals = 0; // æ²’åˆ° 12:30ï¼Œç®— 0 é¤ (é€™æ¯”è¼ƒåš´æ ¼ï¼Œèˆ‡åŸå§‹å‚™è¨»"åªè¦æœ‰åŠ ç­ï¼ŒåŸºæœ¬ä¸€é¤"è¡çª)
                 // ä¾ç…§åŸå§‹å‚™è¨» "åªè¦æœ‰åŠ ç­ï¼ŒåŸºæœ¬ä¸€é¤"ï¼Œä½†è‹¥æ²’éç”¨é¤æ™‚é–“ï¼Œå‰‡é¤è²»å¯èƒ½ä¸æˆç«‹
                 // é€™è£¡æš«æ™‚ç¶­æŒåŸé‚è¼¯ï¼šåªè¦æœ‰åŠ ç­æ™‚æ•¸ï¼Œè‡³å°‘ 1 é¤ã€‚
                 result.meals = 1; 
            }
        } else {
            result.meals = 0;
        }

      }

      // ç¸½åŠ ç­è²»è¨ˆç®— (å››æ¨äº”å…¥)
      result.otPay = result.h133 * hourly * 1.34 + result.h166 * hourly * 1.67 + result.h200 * hourly * 2.0 + result.h267 * hourly * 2.67;
      result.otPay = Math.round(result.otPay);
      
      // é¤è²»è¨ˆç®—
      result.mealFee = result.meals * 130;
      
      // è£œä¼‘æŠ˜ç¾ (ç”¨åŸºæœ¬æ™‚è–ª)
      result.compCash = result.comp * hourly; 

      return result;
    }

    function recalcRow(tr) {
      const dateStr = tr.dataset.date;
      const dateObj = new Date(dateStr);
      const hourly = getHourlyBase();
      const startSel = tr.querySelector(".start-time");
      const endSel = tr.querySelector(".end-time");
      const leaveSel = tr.querySelector(".leave-type");
      const leaveType = leaveSel ? leaveSel.value : "normal";

      const startMin = parseTimeToMinutes(startSel.value);
      const endMin = parseTimeToMinutes(endSel.value);
      const weekday = dateObj.getDay();
      const isWeekend = (weekday === 0 || weekday === 6);
      const holiday = isNationalHoliday(dateObj);
      const isHolidayType = isWeekend || holiday;
      
      let invalidRow = false;
      if (!isHolidayType && endMin !== null && startMin !== null && endMin <= startMin) {
        invalidRow = true;
      }
      tr.classList.toggle("invalid-row", invalidRow);

      const stats = computeDayStats(dateObj, startSel.value, endSel.value, hourly, leaveType);
      
      // æ›´æ–° dayData (å¿…é ˆå…ˆæ–¼ computeDayStats åŸ·è¡Œï¼Œå› ç‚º dayData æœƒåœ¨ handler ä¸­è¢«æ›´æ–°)
      dayData[dateStr].start = startSel.value;
      dayData[dateStr].end = endSel.value;
      dayData[dateStr].leaveType = leaveType;
      dayData[dateStr].stats = stats; // å„²å­˜è¨ˆç®—çµæœï¼Œæ–¹ä¾¿åŒ¯å‡º

      // æ›´æ–°è¡¨æ ¼æ¬„ä½
      tr.querySelector(".hours133").textContent = fmtNumber(stats.h133);
      tr.querySelector(".hours166").textContent = fmtNumber(stats.h166);
      tr.querySelector(".hours200").textContent = fmtNumber(stats.h200);
      tr.querySelector(".hours267").textContent = fmtNumber(stats.h267);
      tr.querySelector(".compHours").textContent = fmtNumber(stats.comp);
      tr.querySelector(".otPay").textContent = fmtMoney(stats.otPay);
      tr.querySelector(".mealCount").textContent = String(stats.meals);
      tr.querySelector(".mealFee").textContent = fmtMoney(stats.mealFee);
      
      updateMonthlySummary();
      updatePayPeriodSummary();
      saveState();
    }

    function buildMonthTable() {
      const month = Number(document.getElementById("monthSelect").value);
      currentYear = Number(document.getElementById("yearInput").value);
      const tbody = document.getElementById("daysBody");
      tbody.innerHTML = "";

      const weekNames = ["æ—¥", "ä¸€", "äºŒ", "ä¸‰", "å››", "äº”", "å…­"];
      const daysInMonth = new Date(currentYear, month, 0).getDate();

      // ç¢ºä¿è©²å¹´ä»½/æœˆä»½çš„è³‡æ–™çµæ§‹å­˜åœ¨
      initYearData(currentYear);

      for (let day = 1; day <= daysInMonth; day++) {
        const dateObj = new Date(currentYear, month - 1, day);
        const weekday = dateObj.getDay(); // 0 (Sun) to 6 (Sat)
        const dateStr = `${currentYear}-${String(month).padStart(2, "0")}-${String(day).padStart(2, "0")}`;
        
        // è¼‰å…¥æˆ–åˆå§‹åŒ–è©²æ—¥æœŸçš„è³‡æ–™
        let stored = dayData[dateStr];
        if (!stored) {
          stored = { start: "08:00", end: "17:00", leaveType: "normal" };
          dayData[dateStr] = stored;
        }

        const holiday = isNationalHoliday(dateObj);
        const isWeekend = (weekday === 0 || weekday === 6);
        const isHolidayType = isWeekend || holiday;

        const tr = document.createElement("tr");
        tr.dataset.date = dateStr;
        
        if (holiday) {
          tr.className = "national-holiday-row";
        } else if (isWeekend) {
          tr.className = "weekend-row";
        } else {
          tr.className = "weekday-row";
        }

        // 1. æ—¥æœŸ
        const tdDate = document.createElement("td");
        tdDate.textContent = dateStr.substring(5);
        if (holiday) tdDate.classList.add("holiday-date");
        tr.appendChild(tdDate);
        
        // 2. æ˜ŸæœŸ
        const tdWeekday = document.createElement("td");
        tdWeekday.textContent = weekNames[weekday];
        tr.appendChild(tdWeekday);
        
        // 3. é¡å‹
        const tdType = document.createElement("td");
        tdType.textContent = isHolidayType ? "å‡æ—¥/åœ‹å®šå‡æ—¥" : "å¹³æ—¥";
        tr.appendChild(tdType);
        
        // 4. å‡åˆ¥
        const tdLeave = document.createElement("td");
        const leaveSel = createLeaveSelect();
        leaveSel.value = stored.leaveType || "normal";
        tdLeave.appendChild(leaveSel);
        tr.appendChild(tdLeave);
        
        // 5. ä¸Šç­æ™‚é–“ (Start)
        const tdStart = document.createElement("td");
        const startSel = createSelect(allTimes, "start-time");
        startSel.value = stored.start;
        tdStart.appendChild(startSel);
        tr.appendChild(tdStart);
        
        // 6. ä¸‹ç­æ™‚é–“ (End)
        const tdEnd = document.createElement("td");
        const endOptions = isHolidayType ? allTimes : weekdayEndTimes;
        const endSel = createSelect(endOptions, "end-time");
        let endDefault = stored.end;
        if (!endOptions.includes(endDefault)) {
            endDefault = isHolidayType ? "00:00" : "17:00";
        }
        endSel.value = endDefault;
        tdEnd.appendChild(endSel);
        tr.appendChild(tdEnd);

        // 7. åŠ ç­è²»èˆ‡é¤è²»æ¬„ä½
        const cols = ["hours133","hours166","hours200","hours267","compHours","otPay","mealCount","mealFee"];
        for (const c of cols) {
          const td = document.createElement("td");
          td.className = c;
          td.textContent = "0";
          tr.appendChild(td);
        }

        // äº‹ä»¶ç›£è½ (å‘¼å« recalcRow æœƒè‡ªå‹• saveState)
        leaveSel.addEventListener("change", () => recalcRow(tr));
        startSel.addEventListener("change", () => recalcRow(tr));
        endSel.addEventListener("change", () => recalcRow(tr));

        tbody.appendChild(tr);
        
        // é¦–æ¬¡è¨ˆç®—ä¸¦é¡¯ç¤º
        recalcRow(tr);
      }
    }

    function initYearData(year) {
        // ç”±æ–¼æˆ‘å€‘ä½¿ç”¨ dayData çµ±ä¸€å„²å­˜ï¼Œé€™å€‹å‡½å¼ç›®å‰åªç¢ºä¿äº† currentYear
        // ä½†åœ¨æœªä¾†å¦‚æœéœ€è¦è™•ç†è·¨å¹´ä»½è³‡æ–™çµæ§‹ï¼Œæ­¤è™•æ˜¯å…¥å£
        // é€™è£¡ç¢ºä¿ dayData å·²ç¶“åŒ…å«æ‰€æœ‰æ—¥æœŸæˆ–æœƒåœ¨ä½¿ç”¨æ™‚è‡ªå‹•åˆå§‹åŒ–
    }

    function updateMonthlySummary() {
      const month = Number(document.getElementById("monthSelect").value);
      let sum133 = 0, sum166 = 0, sum200 = 0, sum267 = 0, sumComp = 0;
      let sumOTPay = 0, sumMeals = 0, sumMealFee = 0;
      const hourly = getHourlyBase();
      const daysInMonth = new Date(currentYear, month, 0).getDate();

      for (let day = 1; day <= daysInMonth; day++) {
        const dateStr = `${currentYear}-${String(month).padStart(2, "0")}-${String(day).padStart(2, "0")}`;
        const data = dayData[dateStr];
        
        if (data && data.stats) {
          const stats = data.stats;
          sum133 += stats.h133;
          sum166 += stats.h166;
          sum200 += stats.h200;
          sum267 += stats.h267;
          sumComp += stats.comp;
          sumOTPay += stats.otPay;
          sumMeals += stats.meals;
          sumMealFee += stats.mealFee;
        }
      }

      const totalHours = sum133 + sum166 + sum200 + sum267;
      const compCash = sumComp * hourly;
      
      document.getElementById("sum133").textContent = fmtNumber(sum133);
      document.getElementById("sum166").textContent = fmtNumber(sum166);
      document.getElementById("sum200").textContent = fmtNumber(sum200);
      document.getElementById("sum267").textContent = fmtNumber(sum267);
      document.getElementById("totalHours").textContent = fmtNumber(totalHours);
      document.getElementById("sumComp").textContent = fmtNumber(sumComp);
      document.getElementById("sumOTPayMonthly").textContent = fmtMoney(sumOTPay);
      document.getElementById("sumMealsMonthly").textContent = String(sumMeals);
      document.getElementById("sumMealFeeMonthly").textContent = fmtMoney(sumMealFee);
      document.getElementById("compCashMonthly").textContent = fmtMoney(compCash);
      
      // æ›´æ–°é¡¯ç¤ºè¨­å®š
      applyVisibilitySettings();
    }

    function getSettlementDay(month) {
      const input = document.getElementById("cutoff" + month);
      let d = Number(input.value) || 0;
      const daysInMonth = new Date(currentYear, month, 0).getDate();
      if (d < 1) d = daysInMonth;
      if (d > daysInMonth) d = daysInMonth;
      input.value = d;
      return d;
    }

    function formatDateLocal(date) {
      const y = date.getFullYear();
      const m = String(date.getMonth() + 1).padStart(2, "0");
      const d = String(date.getDate()).padStart(2, "0");
      return `${y}-${m}-${d}`;
    }

    function updatePayPeriodSummary() {
      const payMonth = Number(document.getElementById("payMonthSelect").value);
      const hourly = getHourlyBase();
      const endDay = getSettlementDay(payMonth);
      
      let startDate, endDate;
      let startDay;

      // ç•¶æœˆçµç®—æ—¥
      endDate = new Date(currentYear, payMonth - 1, endDay);
      
      if (payMonth === 1) {
        // 1æœˆçµç®—æ—¥ (å‡è¨­å¾ 1/1 é–‹å§‹ç®—)
        startDate = new Date(currentYear, 0, 1);
      } else {
        // å…¶ä»–æœˆä»½ï¼šå¾ä¸Šä¸€å€‹æœˆä»½çš„çµç®—æ—¥+1å¤©é–‹å§‹
        const prevMonth = payMonth - 1;
        const prevCutoffDay = getSettlementDay(prevMonth);
        const daysPrevMonth = new Date(currentYear, prevMonth, 0).getDate();
        
        startDay = Math.min(prevCutoffDay + 1, daysPrevMonth + 1); // å¦‚æœä¸Šå€‹æœˆçµç®—æ—¥æ˜¯ 31ï¼Œå‰‡ startDay ç‚º 32ï¼Œæœƒè‡ªå‹•è·³åˆ°ä¸‹å€‹æœˆ 1 è™Ÿ
        startDate = new Date(currentYear, prevMonth - 1, startDay); // JavaScript æœƒè‡ªå‹•æ ¡æ­£
        
        // è™•ç†è·¨å¹´å•é¡Œ (PayMonth = 1 æ™‚ï¼Œè¦å¾å‰ä¸€å¹´çš„ 12 æœˆçµç®—æ—¥+1é–‹å§‹)
        if (payMonth === 1 && currentYear > 2000) {
            const prevYear = currentYear - 1;
            const cutoff12PrevYear = getSettlementDay(12); // ä½¿ç”¨ç•¶å‰è¨­å®šçš„ 12 æœˆçµç®—æ—¥
            const daysPrevYear12 = new Date(prevYear, 12, 0).getDate(); // 12 æœˆå¤©æ•¸
            startDay = Math.min(cutoff12PrevYear + 1, daysPrevYear12 + 1);
            startDate = new Date(prevYear, 12 - 1, startDay); // ä¿®æ­£åˆ°å‰ä¸€å¹´ 12 æœˆ
        }
      }
      
      // ç¢ºä¿æ—¥æœŸæ˜¯ YYYY-MM-DD
      const startStr = formatDateLocal(startDate);
      const endStr = formatDateLocal(endDate);
      
      // æ›´æ–°çµç®—å€é–“é¡¯ç¤º
      const periodText = `çµç®—å€é–“ï¼š${startStr} åˆ° ${endStr} (å«é ­å°¾)`;
      document.getElementById("payPeriodLabel").textContent = periodText;
      document.getElementById("payPeriodLabel2").textContent = periodText;

      // ç´¯è¨ˆè¨ˆç®—
      let currentDate = new Date(startDate);
      let sumOTPay = 0, sumComp = 0, sumSickH = 0, sumPersonalH = 0;
      let sumSickDed = 0, sumPersonalDed = 0;
      let ppH133 = 0, ppH166 = 0, ppH200 = 0, ppH267 = 0;

      while (currentDate <= endDate) {
        const dateStr = formatDateLocal(currentDate);
        const data = dayData[dateStr];
        
        if (data && data.stats) {
          const stats = data.stats;
          sumOTPay += stats.otPay;
          sumComp += stats.comp;
          sumSickH += stats.sickLeaveHours;
          sumPersonalH += stats.personalLeaveHours;
          sumSickDed += stats.sickDeduction;
          sumPersonalDed += stats.personalDeduction;
          ppH133 += stats.h133;
          ppH166 += stats.h166;
          ppH200 += stats.h200;
          ppH267 += stats.h267;
        }

        currentDate.setDate(currentDate.getDate() + 1);
      }

      // ç¸½çµç®—
      const compCash = sumComp * hourly;
      const ppTotalHours = ppH133 + ppH166 + ppH200 + ppH267;
      
      const fixedIncome = Number(document.getElementById("fixedIncomeDisplay").textContent.replace(/,/g, "")) || 0;
      const fixedOutgo = Number(document.getElementById("fixedOutgoDisplay").textContent.replace(/,/g, "")) || 0;

      const totalLeaveDeduction = sumSickDed + sumPersonalDed;
      const onCallCount = Number(document.getElementById("onCallCount").value) || 0;
      const onCallRate = 1500;
      const onCallPay = onCallCount * onCallRate;
      
      const extraIncomeNoComp = sumOTPay + onCallPay;
      const totalIncome = fixedIncome + extraIncomeNoComp + compCash - fixedOutgo - totalLeaveDeduction;

      // æ›´æ–°é¡¯ç¤º
      document.getElementById("ppTotalHours").textContent = fmtNumber(ppTotalHours);
      document.getElementById("ppH133").textContent = fmtNumber(ppH133);
      document.getElementById("ppH166").textContent = fmtNumber(ppH166);
      document.getElementById("ppH200").textContent = fmtNumber(ppH200);
      document.getElementById("ppH267").textContent = fmtNumber(ppH267);
      document.getElementById("ppSumOTPay").textContent = fmtMoney(sumOTPay);
      document.getElementById("ppCompCash").textContent = fmtMoney(compCash);
      document.getElementById("sickHours").textContent = fmtNumber(sumSickH);
      document.getElementById("personalHours").textContent = fmtNumber(sumPersonalH);
      document.getElementById("sickDeduction").textContent = fmtMoney(sumSickDed);
      document.getElementById("personalDeduction").textContent = fmtMoney(sumPersonalDed);
      document.getElementById("onCallCountDisplay").textContent = String(onCallCount);
      document.getElementById("onCallAmountDisplay").textContent = fmtMoney(onCallPay);
      document.getElementById("totalIncome").textContent = fmtMoney(totalIncome);
      
      // æ›´æ–°é¡¯ç¤ºè¨­å®š
      applyVisibilitySettings();
    }

    function applyVisibilitySettings() {
      const showOT = document.getElementById("chkShowMonthlyOT").checked;
      const showMeal = document.getElementById("chkShowMonthlyMeal").checked;
      const showSalary = document.getElementById("chkShowSalary").checked;

      document.getElementById("sectionMonthlyOT").classList.toggle("hidden", !showOT);
      document.getElementById("sectionMonthlyMeal").classList.toggle("hidden", !showMeal);
      document.getElementById("sectionSalary").classList.toggle("hidden", !showSalary);

      // éš±è—/é¡¯ç¤ºæœˆåº¦çµ±è¨ˆæ¬„ä½
      const monthlyFieldIds = [
        "fieldMonthlyTotalHours", "fieldMonthly133", "fieldMonthly166",
        "fieldMonthly200", "fieldMonthly267", "fieldMonthlyCompHours",
        "fieldMonthlyCompCash", "fieldMonthlyOTPay",
        "fieldMonthlyMealCount", "fieldMonthlyMealFee"
      ];
      monthlyFieldIds.forEach(id => {
        const itemEl = document.getElementById("item" + id.substring(6)); // e.g., itemMonthlyTotalHours
        if (itemEl) {
          const checkboxEl = document.getElementById(id);
          itemEl.classList.toggle("hidden", checkboxEl && !checkboxEl.checked);
        }
      });
      
      // éš±è—/é¡¯ç¤ºè–ªè³‡è©¦ç®—æ¬„ä½
      const salaryFieldIds = [
        "fieldSalaryFixIn", "fieldSalaryFixOut", "fieldSalaryTotalHours",
        "fieldSalary133", "fieldSalary166", "fieldSalary200", "fieldSalary267",
        "fieldSalaryOTPay", "fieldSalaryCompCash",
        "fieldSalaryOncallCount", "fieldSalaryOncallAmount",
        "fieldSalarySickH", "fieldSalarySickDed",
        "fieldSalaryPersonalH", "fieldSalaryPersonalDed",
        "fieldSalaryTotalIncome"
      ];
      salaryFieldIds.forEach(id => {
        const itemEl = document.getElementById("item" + id.substring(6)); // e.g., itemSalaryFixIn
        if (itemEl) {
          const checkboxEl = document.getElementById(id);
          itemEl.classList.toggle("hidden", checkboxEl && !checkboxEl.checked);
        }
      });
    }

    function exportJSON() {
      try {
        const state = getCurrentStateObject();
        const json = JSON.stringify(state, null, 2);
        
        const blob = new Blob([json], { type: "application/json" });
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        const now = new Date();
        const ts = `${now.getFullYear()}${String(now.getMonth()+1).padStart(2,"0")}${String(now.getDate()).padStart(2,"0")}`;
        a.href = url;
        a.download = `xunde_overtime_${ts}.json`;
        document.body.appendChild(a);
        a.click();
        a.remove();
        URL.revokeObjectURL(url);
      } catch (e) {
        alert("åŒ¯å‡ºå¤±æ•—");
        console.warn(e);
      }
    }

    function exportCSV() {
      try {
        const hourly = getHourlyBase();
        const rows = [];
        rows.push("æ—¥æœŸ,æ˜ŸæœŸ,é¡å‹,å‡åˆ¥,ä¸Šç­,ä¸‹ç­,1.34å°æ™‚,1.67å°æ™‚,2.0å°æ™‚,2.67å°æ™‚,è£œä¼‘æ™‚æ•¸,åŠ ç­è²»,èª¤é¤æ•¸,èª¤é¤è²»,ç—…å‡æ™‚æ•¸,ç—…å‡æ‰£æ¬¾,äº‹å‡æ™‚æ•¸,äº‹å‡æ‰£æ¬¾");
        const weekNames = ["æ—¥","ä¸€","äºŒ","ä¸‰","å››","äº”","å…­"];

        for (let month = 1; month <= 12; month++) {
          const daysInMonth = new Date(currentYear, month, 0).getDate();
          for (let day = 1; day <= daysInMonth; day++) {
            const dateObj = new Date(currentYear, month - 1, day);
            const y = currentYear;
            const m = String(month).padStart(2, "0");
            const d = String(day).padStart(2, "0");
            const dateStr = `${y}-${m}-${d}`;
            
            const data = dayData[dateStr] || { start: "00:00", end: "00:00", leaveType: "normal" };
            const weekday = dateObj.getDay();
            const isWeekend = (weekday === 0 || weekday === 6);
            const holiday = isNationalHoliday(dateObj);
            const isHolidayType = isWeekend || holiday;
            const typeText = isHolidayType ? "å‡æ—¥/åœ‹å®šå‡æ—¥" : "å¹³æ—¥";
            
            let leaveText = "æ­£å¸¸ä¸Šç­";
            if (data.leaveType === "annual") leaveText = "ç‰¹ä¼‘";
            if (data.leaveType === "comp") leaveText = "è£œä¼‘";
            if (data.leaveType === "sick") leaveText = "ç—…å‡";
            if (data.leaveType === "personal") leaveText = "äº‹å‡";

            // é‡æ–°è¨ˆç®— stats ä»¥ç¢ºä¿æ˜¯æœ€æ–°çš„ (é›–ç„¶æ¯æ¬¡è¼¸å…¥éƒ½æœƒå­˜)
            const stats = computeDayStats(dateObj, data.start, data.end, hourly, data.leaveType || "normal");
            
            const row = [
              dateStr,
              weekNames[weekday],
              typeText,
              leaveText,
              data.start,
              data.end,
              fmtNumber(stats.h133),
              fmtNumber(stats.h166),
              fmtNumber(stats.h200),
              fmtNumber(stats.h267),
              fmtNumber(stats.comp),
              fmtMoney(stats.otPay),
              String(stats.meals),
              fmtMoney(stats.mealFee),
              fmtNumber(stats.sickLeaveHours),
              fmtMoney(stats.sickDeduction),
              fmtNumber(stats.personalLeaveHours),
              fmtMoney(stats.personalDeduction)
            ];
            rows.push(row.join(","));
          }
        }

        const csvContent = "\ufeff" + rows.join("\n"); // \ufeff for BOM to ensure Chinese compatibility
        const blob = new Blob([csvContent], { type: "text/csv;charset=utf-8;" });
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        const now = new Date();
        const ts = `${now.getFullYear()}${String(now.getMonth()+1).padStart(2,"0")}${String(now.getDate()).padStart(2,"0")}`;
        a.href = url;
        a.download = `xunde_overtime_detail_${ts}.csv`;
        document.body.appendChild(a);
        a.click();
        a.remove();
        URL.revokeObjectURL(url);
      } catch (e) {
        alert("åŒ¯å‡º CSV å¤±æ•—");
        console.warn(e);
      }
    }

    function exportPDF() {
      // å‘¼å«ç€è¦½å™¨åˆ—å°åŠŸèƒ½
      window.print();
    }

    function renderRandomMeme() {
      const category = document.getElementById("memeCategory").value;
      const filteredMemes = memeList.filter(m => category === 'all' || m.tag === category || m.tag === 'mix');
      if (filteredMemes.length === 0) {
        document.getElementById("memeTitle").textContent = "æ²’æœ‰æ¢—äº†...";
        document.getElementById("memeSubtitle").textContent = "è«‹åˆ‡æ›åˆ†é¡æˆ–åŠ å…¥æ–°æ¢—ã€‚";
        return;
      }
      const randomIndex = Math.floor(Math.random() * filteredMemes.length);
      const meme = filteredMemes[randomIndex];
      document.getElementById("memeTitle").textContent = meme.title;
      document.getElementById("memeSubtitle").textContent = meme.subtitle;
    }
    
    // =================================================================
    // åˆå§‹åŒ–èˆ‡äº‹ä»¶ç›£è½
    // =================================================================
    
    async function init() {
      // è¼‰å…¥ Gist é›²ç«¯è³‡æ–™ (ç­‰å¾…å®Œæˆ)
      await loadState();
      
      // åˆå§‹åŒ–å¹´ä»½è³‡æ–™
      initYearData(currentYear);
      document.getElementById("yearInput").value = currentYear;
      
      // é¦–æ¬¡è¨ˆç®—å’Œæ¸²æŸ“
      recalcSalaryStructureSummary();
      buildMonthTable();
      updatePayPeriodSummary(); // ç¢ºä¿çµç®—å€é–“åœ¨è¼‰å…¥å¾Œç«‹å³æ›´æ–°
      applyVisibilitySettings();
      renderRandomMeme();
      
      // ç¶å®šæ‰€æœ‰ input/select äº‹ä»¶ç›£è½ (äº‹ä»¶è§¸ç™¼æ™‚æœƒå‘¼å« saveState)
      
      // è–ªè³‡çµæ§‹è¼¸å…¥ç›£è½
      [
        "baseSalary", "dutyAllowance", "trafficAllowance", "maintenanceAllowance",
        "stockCompanyIncome", "laborInsurance", "healthInsurance",
        "stockCompanyDeduct", "stockSelfDeduct"
      ].forEach(id => {
        const el = document.getElementById(id);
        if (el) el.addEventListener("input", () => {
            recalcSalaryStructureSummary();
            saveState(); // å„²å­˜ç‹€æ…‹
        });
      });

      // å¹´ä»½/æœˆä»½/onCall é¸æ“‡ç›£è½
      document.getElementById("yearInput").addEventListener("change", () => { 
        currentYear = Number(document.getElementById("yearInput").value);
        initYearData(currentYear);
        buildMonthTable();
        updatePayPeriodSummary();
        saveState();
      });
      document.getElementById("monthSelect").addEventListener("change", () => {
        buildMonthTable();
        saveState();
      }); // buildMonthTable æœƒå‘¼å« updateMonthlySummary/updatePayPeriodSummary/saveState
      document.getElementById("payMonthSelect").addEventListener("change", () => {
        updatePayPeriodSummary();
        saveState();
      });
      document.getElementById("onCallCount").addEventListener("input", () => {
        updatePayPeriodSummary();
        saveState();
      });

      // çµç®—æ—¥è¼¸å…¥ç›£è½
      for (let m = 1; m <= 12; m++) {
        const el = document.getElementById("cutoff" + m);
        if (el) {
          el.addEventListener("input", () => {
            updatePayPeriodSummary();
            saveState();
          });
        }
      }

      // é¡¯ç¤ºè¨­å®šå‹¾é¸ç›£è½
      [
        "chkShowMonthlyOT", "chkShowMonthlyMeal", "chkShowSalary",
        "fieldMonthlyTotalHours", "fieldMonthly133", "fieldMonthly166",
        "fieldMonthly200", "fieldMonthly267", "fieldMonthlyCompHours",
        "fieldMonthlyCompCash", "fieldMonthlyOTPay",
        "fieldMonthlyMealCount", "fieldMonthlyMealFee",
        "fieldSalaryFixIn", "fieldSalaryFixOut", "fieldSalaryTotalHours",
        "fieldSalary133", "fieldSalary166", "fieldSalary200", "fieldSalary267",
        "fieldSalaryOTPay", "fieldSalaryCompCash",
        "fieldSalaryOncallCount", "fieldSalaryOncallAmount",
        "fieldSalarySickH", "fieldSalarySickDed",
        "fieldSalaryPersonalH", "fieldSalaryPersonalDed",
        "fieldSalaryTotalIncome"
      ].forEach(id => {
        const el = document.getElementById(id);
        if (el) el.addEventListener("change", () => {
          applyVisibilitySettings();
          saveState();
        });
      });

      // æ¢—åœ–æŒ‰éˆ•ç›£è½
      document.getElementById("btnChangeMeme").addEventListener("click", renderRandomMeme);
      document.getElementById("memeCategory").addEventListener("change", renderRandomMeme);

      // è¨­å®šé¢æ¿é–‹é—œ
      document.getElementById("btnSettings").addEventListener("click", () => {
        document.getElementById("settingsPanel").classList.toggle("hidden");
      });

      // åŒ¯å…¥ JSON (ä¸Šå‚³è‡³ Gist)
      const importInput = document.getElementById("importJsonInput");
      if (importInput) {
        importInput.addEventListener("change", async (e) => { // å¿…é ˆæ˜¯ async
          const file = e.target.files[0];
          if (!file) return;
          const reader = new FileReader();
          reader.onload = async (ev) => {
            try {
              const text = ev.target.result;
              JSON.parse(text); // é©—è­‰ JSON æ ¼å¼
              
              // 1. ä¸Šå‚³è‡³ Gist (è¦†è“‹)
              const success = await updateGistContent(text);
              if (!success) {
                  alert("åŒ¯å…¥å¤±æ•—ï¼šç„¡æ³•ä¸Šå‚³è‡³é›²ç«¯ Gistã€‚");
                  return;
              }

              // 2. é‡æ–°è¼‰å…¥ç‹€æ…‹ä¸¦æ¸²æŸ“ä»‹é¢
              await loadState();
              initYearData(currentYear);
              recalcSalaryStructureSummary();
              buildMonthTable();
              applyVisibilitySettings();
              updatePayPeriodSummary();
              renderRandomMeme();
              
              alert("åŒ¯å…¥æˆåŠŸï¼è³‡æ–™å·²åŒæ­¥è‡³é›²ç«¯ Gistã€‚");
              
            } catch (err) {
              console.warn(err);
              alert("åŒ¯å…¥å¤±æ•—ï¼Œæª”æ¡ˆæ ¼å¼å¯èƒ½æœ‰å•é¡Œ");
            } finally {
              importInput.value = "";
            }
          };
          reader.readAsText(file);
        });
      }
    }

    document.addEventListener("DOMContentLoaded", init);
  </script>
</body>
</html>